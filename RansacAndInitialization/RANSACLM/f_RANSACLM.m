function [bestInliersPosition,ParaLBest] = f_RANSACLM(alpha,beita,gama,u1,v1,u2,v2,u3,v3,ParaL0,Nransac,Ti,Nr,NLM)
%function:RANSAC-Driven LM parameter optimization algorithm

%Input：
%alpha,beita,gama,u1,v1,u2,v2,u3,v3 are data
%alpha,beita,gama are the joint angles of the boom,arm, and bucket, respectively
%(u1,v1),(u2,v2),(u3,v3)represent the FPPC of the boom, stick, and bucket, respectively
%ParaL0 is initial valuse
%Nransac,Ti,Nr,NLM are parameters of algorithm

%Output:
%bestInliersPosition is Interior point position
%ParaLBest is Optimal parameters

%%
bestInliersPosition=[];%Interior point position

%% Geometric parameters of excavator linkage
l1=3710.347;
l2=1615.225;

%%
Nu=length(alpha);%Actual amount of data

%% ransac
for k = 1:Nransac
    %% Randomly select Nr points from the data as candidate points for the model
    Position = randperm(Nu, Nr);
    sample_alpha=alpha(Position);
    sample_beita=beita(Position);
    sample_gama=gama(Position);
    sample_u1=u1(Position);
    sample_v1=v1(Position);
    sample_u2=u2(Position);
    sample_v2=v2(Position);
    sample_u3=u3(Position);
    sample_v3=v3(Position);
    
    T=100000;%iterations
    ErrorTolerance=10^-6;
    ParaL_hat=zeros(24,1);%Store all optimization parameters for the current iteration
    ParaLAll=zeros(24,T);%Store optimization parameters for all iterative processes
    ParaLAll(:,1)=ParaL0;
    E=zeros(6*Nr,1);%Error of all points in a single iteration
    JN=zeros(6*Nr,4);%The Jacobian matrix with respect to internal parameters in the overall Jacobian matrix
    JT=zeros(6*Nr,6);%The Jacobian matrix in the overall Jacobian matrix regarding the attitude relationship of the camera base
    JD=zeros(6*Nr,5);%The Jacobian matrix for camera lens distortion in the overall Jacobian matrix
    JM=zeros(6*Nr,9);%The Jacobian matrix in the overall Jacobian matrix regarding the target pasting position
    u=0.1;
    Esum2=zeros(T-1,1);%The sum of squared total errors of all points in each iteration is then squared.

    % LM
    for t=2:T%
        ParaL_hat=ParaLAll(:,t-1);
        fx_hat=ParaL_hat(1);
        u0_hat=ParaL_hat(2);
        fy_hat=ParaL_hat(3);
        v0_hat=ParaL_hat(4);
        rou1_hat=ParaL_hat(5);
        rou2_hat=ParaL_hat(6);
        rou3_hat=ParaL_hat(7);
        fai1_hat=ParaL_hat(8);
        fai2_hat=ParaL_hat(9);
        fai3_hat=ParaL_hat(10);
        k1_hat=ParaL_hat(11);
        k2_hat=ParaL_hat(12);
        p1_hat=ParaL_hat(13);
        p2_hat=ParaL_hat(14);
        k3_hat=ParaL_hat(15);
        lA_hat=ParaL_hat(16);
        lB_hat=ParaL_hat(17);
        lC_hat=ParaL_hat(18);
        alpha1_hat=ParaL_hat(19);
        beita1_hat=ParaL_hat(20);
        gama1_hat=ParaL_hat(21);
        Z1_hat=ParaL_hat(22);
        Z2_hat=ParaL_hat(23);
        Z3_hat=ParaL_hat(24);
        K_hat=[fx_hat 0 u0_hat;0 fy_hat v0_hat;0 0 1];
        T_hat=roufai2T([rou1_hat;rou2_hat;rou3_hat],[fai1_hat;fai2_hat;fai3_hat]);
        for i=1:Nr
            %World coordinates of three feature points
            XYZ_1_hat=[lA_hat*cos(sample_alpha(i)+alpha1_hat);...
                       lA_hat*sin(sample_alpha(i)+alpha1_hat);Z1_hat];%World coordinates of the center of mass of the target boom 
            XYZ_2_hat=[l1*cos(sample_alpha(i))+lB_hat*cos(sample_alpha(i)+sample_beita(i)+beita1_hat);...
                       l1*sin(sample_alpha(i))+lB_hat*sin(sample_alpha(i)+sample_beita(i)+beita1_hat);...
                       Z2_hat];%World coordinates of the center of mass of the target arm 
            XYZ_3_hat=[l1*cos(sample_alpha(i))+l2*cos(sample_alpha(i)+sample_beita(i))+...
                       lC_hat*cos(sample_alpha(i)+sample_beita(i)+sample_gama(i)+gama1_hat);...
                       l1*sin(sample_alpha(i))+l2*sin(sample_alpha(i)+sample_beita(i))+...
                       lC_hat*sin(sample_alpha(i)+sample_beita(i)+sample_gama(i)+gama1_hat);...
                       Z3_hat];%World coordinates of the center of mass of the target target 

            %Camera coordinates
            XcYcZc_1_hat=T_hat*[XYZ_1_hat;1];
            XcYcZc_2_hat=T_hat*[XYZ_2_hat;1];
            XcYcZc_3_hat=T_hat*[XYZ_3_hat;1];

            %Ideal normalized coordinates
            xi_bar_1_hat=XcYcZc_1_hat(1)/XcYcZc_1_hat(3);
            yi_bar_1_hat=XcYcZc_1_hat(2)/XcYcZc_1_hat(3);
            r_1_hat=sqrt(xi_bar_1_hat^2+yi_bar_1_hat^2);
            xi_bar_2_hat=XcYcZc_2_hat(1)/XcYcZc_2_hat(3);
            yi_bar_2_hat=XcYcZc_2_hat(2)/XcYcZc_2_hat(3);
            r_2_hat=sqrt(xi_bar_2_hat^2+yi_bar_2_hat^2);
            xi_bar_3_hat=XcYcZc_3_hat(1)/XcYcZc_3_hat(3);
            yi_bar_3_hat=XcYcZc_3_hat(2)/XcYcZc_3_hat(3);
            r_3_hat=sqrt(xi_bar_3_hat^2+yi_bar_3_hat^2);

            %Distorted normalized coordinates
            xd_bar_1_hat=xi_bar_1_hat*(1+k1_hat*r_1_hat^2+k2_hat*r_1_hat^4+...
                         k3_hat*r_1_hat^6)+2*p1_hat*xi_bar_1_hat*yi_bar_1_hat+...
                         p2_hat*(r_1_hat^2+2*xi_bar_1_hat^2);
            yd_bar_1_hat=yi_bar_1_hat*(1+k1_hat*r_1_hat^2+k2_hat*r_1_hat^4+...
                         k3_hat*r_1_hat^6)+2*p2_hat*xi_bar_1_hat*yi_bar_1_hat+...
                         p1_hat*(r_1_hat^2+2*yi_bar_1_hat^2);
            xd_bar_2_hat=xi_bar_2_hat*(1+k1_hat*r_2_hat^2+k2_hat*r_2_hat^4+...
                         k3_hat*r_2_hat^6)+2*p1_hat*xi_bar_2_hat*yi_bar_2_hat+...
                         p2_hat*(r_2_hat^2+2*xi_bar_2_hat^2);
            yd_bar_2_hat=yi_bar_2_hat*(1+k1_hat*r_2_hat^2+k2_hat*r_2_hat^4+...
                         k3_hat*r_2_hat^6)+2*p2_hat*xi_bar_2_hat*yi_bar_2_hat+...
                         p1_hat*(r_2_hat^2+2*yi_bar_2_hat^2);
            xd_bar_3_hat=xi_bar_3_hat*(1+k1_hat*r_3_hat^2+k2_hat*r_3_hat^4+...
                         k3_hat*r_3_hat^6)+2*p1_hat*xi_bar_3_hat*yi_bar_3_hat+...
                         p2_hat*(r_3_hat^2+2*xi_bar_3_hat^2);
            yd_bar_3_hat=yi_bar_3_hat*(1+k1_hat*r_3_hat^2+k2_hat*r_3_hat^4+...
                         k3_hat*r_3_hat^6)+2*p2_hat*xi_bar_3_hat*yi_bar_3_hat+...
                         p1_hat*(r_3_hat^2+2*yi_bar_3_hat^2);       

            %Pixel coordinates
            UV_1_hat=K_hat*[xd_bar_1_hat;yd_bar_1_hat;1];
            UV_2_hat=K_hat*[xd_bar_2_hat;yd_bar_2_hat;1];
            UV_3_hat=K_hat*[xd_bar_3_hat;yd_bar_3_hat;1];

            %The error of two coordinates of three feature points, totaling 6
            E(6*(i-1)+1,1)=UV_1_hat(1)-sample_u1(i);
            E(6*(i-1)+2,1)=UV_1_hat(2)-sample_v1(i);
            E(6*(i-1)+3,1)=UV_2_hat(1)-sample_u2(i);
            E(6*(i-1)+4,1)=UV_2_hat(2)-sample_v2(i);
            E(6*(i-1)+5,1)=UV_3_hat(1)-sample_u3(i);
            E(6*(i-1)+6,1)=UV_3_hat(2)-sample_v3(i);

            %The Solution of JN Jacobian Matrix
            JN(6*(i-1)+1:6*(i-1)+6,:)=[xd_bar_1_hat 1 0 0;0 0 yd_bar_1_hat 1;...
                                       xd_bar_2_hat 1 0 0;0 0 yd_bar_2_hat 1;...
                                       xd_bar_3_hat 1 0 0;0 0 yd_bar_3_hat 1;];

            %Solving the JT Jacobian Matrix
            dxdbar1_dxibar1=1+3*k1_hat*xi_bar_1_hat^2+k1_hat*yi_bar_1_hat^2+5*k2_hat*xi_bar_1_hat^4+...
                            k2_hat*yi_bar_1_hat^4+6*k2_hat*yi_bar_1_hat^2*xi_bar_1_hat^2+...
                            7*k3_hat*xi_bar_1_hat^6+3*k3_hat*xi_bar_1_hat^2*yi_bar_1_hat^4+...
                            10*k3_hat*xi_bar_1_hat^4*yi_bar_1_hat^2+5*k3_hat*yi_bar_1_hat^2*xi_bar_1_hat^4+...
                            k3_hat*yi_bar_1_hat^6+6*k3_hat*xi_bar_1_hat^2*yi_bar_1_hat^4+2*p1_hat*yi_bar_1_hat+...
                            +6*p2_hat*xi_bar_1_hat;
            dxdbar1_dyibar1=2*k1_hat*xi_bar_1_hat^1*yi_bar_1_hat^1+4*k2_hat*xi_bar_1_hat^1*yi_bar_1_hat^3+...
                            4*k2_hat*xi_bar_1_hat^3*yi_bar_1_hat^1+4*k3_hat*xi_bar_1_hat^3*yi_bar_1_hat^3+...
                            4*k3_hat*xi_bar_1_hat^5*yi_bar_1_hat^1+2*k3_hat*xi_bar_1_hat^5*yi_bar_1_hat^1+...
                            6*k3_hat*xi_bar_1_hat^1*yi_bar_1_hat^5+8*k3_hat*xi_bar_1_hat^3*yi_bar_1_hat^3+...
                            2*p1_hat*xi_bar_1_hat+2*p2_hat*yi_bar_1_hat;
            dydbar1_dxibar1=2*k1_hat*xi_bar_1_hat^1*yi_bar_1_hat^1+4*k2_hat*xi_bar_1_hat^3*yi_bar_1_hat^1+...
                            4*k2_hat*xi_bar_1_hat^1*yi_bar_1_hat^3+6*k3_hat*xi_bar_1_hat^5*yi_bar_1_hat^1+...
                            2*k3_hat*xi_bar_1_hat^1*yi_bar_1_hat^5+8*k3_hat*xi_bar_1_hat^3*yi_bar_1_hat^3+...
                            4*k3_hat*xi_bar_1_hat^3*yi_bar_1_hat^3+4*k3_hat*xi_bar_1_hat^1*yi_bar_1_hat^5+...
                            2*p2_hat*yi_bar_1_hat+2*p1_hat*xi_bar_1_hat;
            dydbar1_dyibar1=1+3*k1_hat*yi_bar_1_hat^2+k1_hat*xi_bar_1_hat^2+5*k2_hat*yi_bar_1_hat^4+...
                            k2_hat*xi_bar_1_hat^4+6*k2_hat*yi_bar_1_hat^2*xi_bar_1_hat^2+...
                            k3_hat*xi_bar_1_hat^6+5*k3_hat*xi_bar_1_hat^2*yi_bar_1_hat^4+...
                            6*k3_hat*xi_bar_1_hat^4*yi_bar_1_hat^2+3*k3_hat*yi_bar_1_hat^2*xi_bar_1_hat^4+...
                            7*k3_hat*yi_bar_1_hat^6+10*k3_hat*xi_bar_1_hat^2*yi_bar_1_hat^4+2*p2_hat*xi_bar_1_hat+...
                            +6*p1_hat*yi_bar_1_hat;
            dxdbar2_dxibar2=1+3*k1_hat*xi_bar_2_hat^2+k1_hat*yi_bar_2_hat^2+5*k2_hat*xi_bar_2_hat^4+...
                            k2_hat*yi_bar_2_hat^4+6*k2_hat*yi_bar_2_hat^2*xi_bar_2_hat^2+...
                            7*k3_hat*xi_bar_2_hat^6+3*k3_hat*xi_bar_2_hat^2*yi_bar_2_hat^4+...
                            10*k3_hat*xi_bar_2_hat^4*yi_bar_2_hat^2+5*k3_hat*yi_bar_2_hat^2*xi_bar_2_hat^4+...
                            k3_hat*yi_bar_2_hat^6+6*k3_hat*xi_bar_2_hat^2*yi_bar_2_hat^4+2*p1_hat*yi_bar_2_hat+...
                            +6*p2_hat*xi_bar_2_hat;
            dxdbar2_dyibar2=2*k1_hat*xi_bar_2_hat^1*yi_bar_2_hat^1+4*k2_hat*xi_bar_2_hat^1*yi_bar_2_hat^3+...
                            4*k2_hat*xi_bar_2_hat^3*yi_bar_2_hat^1+4*k3_hat*xi_bar_2_hat^3*yi_bar_2_hat^3+...
                            4*k3_hat*xi_bar_2_hat^5*yi_bar_2_hat^1+2*k3_hat*xi_bar_2_hat^5*yi_bar_2_hat^1+...
                            6*k3_hat*xi_bar_2_hat^1*yi_bar_2_hat^5+8*k3_hat*xi_bar_2_hat^3*yi_bar_2_hat^3+...
                            2*p1_hat*xi_bar_2_hat+2*p2_hat*yi_bar_2_hat;
            dydbar2_dxibar2=2*k1_hat*xi_bar_2_hat^1*yi_bar_2_hat^1+4*k2_hat*xi_bar_2_hat^3*yi_bar_2_hat^1+...
                            4*k2_hat*xi_bar_2_hat^1*yi_bar_2_hat^3+6*k3_hat*xi_bar_2_hat^5*yi_bar_2_hat^1+...
                            2*k3_hat*xi_bar_2_hat^1*yi_bar_2_hat^5+8*k3_hat*xi_bar_2_hat^3*yi_bar_2_hat^3+...
                            4*k3_hat*xi_bar_2_hat^3*yi_bar_2_hat^3+4*k3_hat*xi_bar_2_hat^1*yi_bar_2_hat^5+...
                            2*p2_hat*yi_bar_2_hat+2*p1_hat*xi_bar_2_hat;
            dydbar2_dyibar2=1+3*k1_hat*yi_bar_2_hat^2+k1_hat*xi_bar_2_hat^2+5*k2_hat*yi_bar_2_hat^4+...
                            k2_hat*xi_bar_2_hat^4+6*k2_hat*yi_bar_2_hat^2*xi_bar_2_hat^2+...
                            k3_hat*xi_bar_2_hat^6+5*k3_hat*xi_bar_2_hat^2*yi_bar_2_hat^4+...
                            6*k3_hat*xi_bar_2_hat^4*yi_bar_2_hat^2+3*k3_hat*yi_bar_2_hat^2*xi_bar_2_hat^4+...
                            7*k3_hat*yi_bar_2_hat^6+10*k3_hat*xi_bar_2_hat^2*yi_bar_2_hat^4+2*p2_hat*xi_bar_2_hat+...
                            +6*p1_hat*yi_bar_2_hat;
            dxdbar3_dxibar3=1+3*k1_hat*xi_bar_3_hat^2+k1_hat*yi_bar_3_hat^2+5*k2_hat*xi_bar_3_hat^4+...
                            k2_hat*yi_bar_3_hat^4+6*k2_hat*yi_bar_3_hat^2*xi_bar_3_hat^2+...
                            7*k3_hat*xi_bar_3_hat^6+3*k3_hat*xi_bar_3_hat^2*yi_bar_3_hat^4+...
                            10*k3_hat*xi_bar_3_hat^4*yi_bar_3_hat^2+5*k3_hat*yi_bar_3_hat^2*xi_bar_3_hat^4+...
                            k3_hat*yi_bar_3_hat^6+6*k3_hat*xi_bar_3_hat^2*yi_bar_3_hat^4+2*p1_hat*yi_bar_3_hat+...
                            +6*p2_hat*xi_bar_3_hat;
            dxdbar3_dyibar3=2*k1_hat*xi_bar_3_hat^1*yi_bar_3_hat^1+4*k2_hat*xi_bar_3_hat^1*yi_bar_3_hat^3+...
                            4*k2_hat*xi_bar_3_hat^3*yi_bar_3_hat^1+4*k3_hat*xi_bar_3_hat^3*yi_bar_3_hat^3+...
                            4*k3_hat*xi_bar_3_hat^5*yi_bar_3_hat^1+2*k3_hat*xi_bar_3_hat^5*yi_bar_3_hat^1+...
                            6*k3_hat*xi_bar_3_hat^1*yi_bar_3_hat^5+8*k3_hat*xi_bar_3_hat^3*yi_bar_3_hat^3+...
                            2*p1_hat*xi_bar_3_hat+2*p2_hat*yi_bar_3_hat;
            dydbar3_dxibar3=2*k1_hat*xi_bar_3_hat^1*yi_bar_3_hat^1+4*k2_hat*xi_bar_3_hat^3*yi_bar_3_hat^1+...
                            4*k2_hat*xi_bar_3_hat^1*yi_bar_3_hat^3+6*k3_hat*xi_bar_3_hat^5*yi_bar_3_hat^1+...
                            2*k3_hat*xi_bar_3_hat^1*yi_bar_3_hat^5+8*k3_hat*xi_bar_3_hat^3*yi_bar_3_hat^3+...
                            4*k3_hat*xi_bar_3_hat^3*yi_bar_3_hat^3+4*k3_hat*xi_bar_3_hat^1*yi_bar_3_hat^5+...
                            2*p2_hat*yi_bar_3_hat+2*p1_hat*xi_bar_3_hat;
            dydbar3_dyibar3=1+3*k1_hat*yi_bar_3_hat^2+k1_hat*xi_bar_3_hat^2+5*k2_hat*yi_bar_3_hat^4+...
                            k2_hat*xi_bar_3_hat^4+6*k2_hat*yi_bar_3_hat^2*xi_bar_3_hat^2+...
                            k3_hat*xi_bar_3_hat^6+5*k3_hat*xi_bar_3_hat^2*yi_bar_3_hat^4+...
                            6*k3_hat*xi_bar_3_hat^4*yi_bar_3_hat^2+3*k3_hat*yi_bar_3_hat^2*xi_bar_3_hat^4+...
                            7*k3_hat*yi_bar_3_hat^6+10*k3_hat*xi_bar_3_hat^2*yi_bar_3_hat^4+2*p2_hat*xi_bar_3_hat+...
                            +6*p1_hat*yi_bar_3_hat;                                       
            du1_dT=[fx_hat 0]*[dxdbar1_dxibar1 dxdbar1_dyibar1;dydbar1_dxibar1 dydbar1_dyibar1]*...
                   [1/XcYcZc_1_hat(3) 0 -XcYcZc_1_hat(1)/XcYcZc_1_hat(3)^2;0 1/XcYcZc_1_hat(3) -XcYcZc_1_hat(2)/XcYcZc_1_hat(3)^2]...
                   *[1 0 0 0 XcYcZc_1_hat(3) -XcYcZc_1_hat(2);0 1 0 -XcYcZc_1_hat(3) 0 XcYcZc_1_hat(1);0 0 1 XcYcZc_1_hat(2) -XcYcZc_1_hat(1) 0];
            dv1_dT=[0 fy_hat]*[dxdbar1_dxibar1 dxdbar1_dyibar1;dydbar1_dxibar1 dydbar1_dyibar1]*...
                   [1/XcYcZc_1_hat(3) 0 -XcYcZc_1_hat(1)/XcYcZc_1_hat(3)^2;0 1/XcYcZc_1_hat(3) -XcYcZc_1_hat(2)/XcYcZc_1_hat(3)^2]...
                   *[1 0 0 0 XcYcZc_1_hat(3) -XcYcZc_1_hat(2);0 1 0 -XcYcZc_1_hat(3) 0 XcYcZc_1_hat(1);0 0 1 XcYcZc_1_hat(2) -XcYcZc_1_hat(1) 0];
            du2_dT=[fx_hat 0]*[dxdbar2_dxibar2 dxdbar2_dyibar2;dydbar2_dxibar2 dydbar2_dyibar2]*...
                   [1/XcYcZc_2_hat(3) 0 -XcYcZc_2_hat(1)/XcYcZc_2_hat(3)^2;0 1/XcYcZc_2_hat(3) -XcYcZc_2_hat(2)/XcYcZc_2_hat(3)^2]...
                   *[1 0 0 0 XcYcZc_2_hat(3) -XcYcZc_2_hat(2);0 1 0 -XcYcZc_2_hat(3) 0 XcYcZc_2_hat(1);0 0 1 XcYcZc_2_hat(2) -XcYcZc_2_hat(1) 0];
            dv2_dT=[0 fy_hat]*[dxdbar2_dxibar2 dxdbar2_dyibar2;dydbar2_dxibar2 dydbar2_dyibar2]*...
                   [1/XcYcZc_2_hat(3) 0 -XcYcZc_2_hat(1)/XcYcZc_2_hat(3)^2;0 1/XcYcZc_2_hat(3) -XcYcZc_2_hat(2)/XcYcZc_2_hat(3)^2]...
                   *[1 0 0 0 XcYcZc_2_hat(3) -XcYcZc_2_hat(2);0 1 0 -XcYcZc_2_hat(3) 0 XcYcZc_2_hat(1);0 0 1 XcYcZc_2_hat(2) -XcYcZc_2_hat(1) 0];
            du3_dT=[fx_hat 0]*[dxdbar3_dxibar3 dxdbar3_dyibar3;dydbar3_dxibar3 dydbar3_dyibar3]*...
                   [1/XcYcZc_3_hat(3) 0 -XcYcZc_3_hat(1)/XcYcZc_3_hat(3)^2;0 1/XcYcZc_3_hat(3) -XcYcZc_3_hat(2)/XcYcZc_3_hat(3)^2]...
                   *[1 0 0 0 XcYcZc_3_hat(3) -XcYcZc_3_hat(2);0 1 0 -XcYcZc_3_hat(3) 0 XcYcZc_3_hat(1);0 0 1 XcYcZc_3_hat(2) -XcYcZc_3_hat(1) 0];
            dv3_dT=[0 fy_hat]*[dxdbar3_dxibar3 dxdbar3_dyibar3;dydbar3_dxibar3 dydbar3_dyibar3]*...
                   [1/XcYcZc_3_hat(3) 0 -XcYcZc_3_hat(1)/XcYcZc_3_hat(3)^2;0 1/XcYcZc_3_hat(3) -XcYcZc_3_hat(2)/XcYcZc_3_hat(3)^2]...
                   *[1 0 0 0 XcYcZc_3_hat(3) -XcYcZc_3_hat(2);0 1 0 -XcYcZc_3_hat(3) 0 XcYcZc_3_hat(1);0 0 1 XcYcZc_3_hat(2) -XcYcZc_3_hat(1) 0];
            JT(6*(i-1)+1:6*(i-1)+6,:)=[du1_dT;dv1_dT;du2_dT;dv2_dT;du3_dT;dv3_dT];

            %Solving JD Jacobian Matrix
            du1_dD=fx_hat*[r_1_hat^2*xi_bar_1_hat,r_1_hat^4*xi_bar_1_hat,2*xi_bar_1_hat*yi_bar_1_hat,...
                           r_1_hat^2+2*xi_bar_1_hat^2,r_1_hat^6*xi_bar_1_hat];
            dv1_dD=fy_hat*[r_1_hat^2*yi_bar_1_hat,r_1_hat^4*yi_bar_1_hat,r_1_hat^2+2*yi_bar_1_hat^2,...
                           2*xi_bar_1_hat*yi_bar_1_hat,r_1_hat^6*yi_bar_1_hat];   
            du2_dD=fx_hat*[r_2_hat^2*xi_bar_2_hat,r_2_hat^4*xi_bar_2_hat,2*xi_bar_2_hat*yi_bar_2_hat,...
                           r_2_hat^2+2*xi_bar_2_hat^2,r_2_hat^6*xi_bar_2_hat];
            dv2_dD=fy_hat*[r_2_hat^2*yi_bar_2_hat,r_2_hat^4*yi_bar_2_hat,r_2_hat^2+2*yi_bar_2_hat^2,...
                           2*xi_bar_2_hat*yi_bar_2_hat,r_2_hat^6*yi_bar_2_hat];    
            du3_dD=fx_hat*[r_3_hat^2*xi_bar_3_hat,r_3_hat^4*xi_bar_3_hat,2*xi_bar_3_hat*yi_bar_3_hat,...
                           r_3_hat^2+2*xi_bar_3_hat^2,r_3_hat^6*xi_bar_3_hat];
            dv3_dD=fy_hat*[r_3_hat^2*yi_bar_3_hat,r_3_hat^4*yi_bar_3_hat,r_3_hat^2+2*yi_bar_3_hat^2,...
                           2*xi_bar_3_hat*yi_bar_3_hat,r_3_hat^6*yi_bar_3_hat];   
            JD(6*(i-1)+1:6*(i-1)+6,:)=[du1_dD;dv1_dD;du2_dD;dv2_dD;du3_dD;dv3_dD];    

            %The Solution of JM Jacobian Matrix
            dxibar1_dX1=(T_hat(1,1)*(T_hat(3,1)*XYZ_1_hat(1)+T_hat(3,2)*XYZ_1_hat(2)+...
                        T_hat(3,3)*XYZ_1_hat(3)+T_hat(3,4))-T_hat(3,1)*(T_hat(1,1)*XYZ_1_hat(1)+...
                        T_hat(1,2)*XYZ_1_hat(2)+T_hat(1,3)*XYZ_1_hat(3)+T_hat(1,4)))...
                        /(T_hat(3,1)*XYZ_1_hat(1)+T_hat(3,2)*XYZ_1_hat(2)+T_hat(3,3)*XYZ_1_hat(3)+T_hat(3,4))^2;
            dX1_dlA=cos(sample_alpha(i)+alpha1_hat);
            dxibar1_dY1=(T_hat(1,2)*(T_hat(3,1)*XYZ_1_hat(1)+T_hat(3,2)*XYZ_1_hat(2)+...
                        T_hat(3,3)*XYZ_1_hat(3)+T_hat(3,4))-T_hat(3,2)*(T_hat(1,1)*XYZ_1_hat(1)+...
                        T_hat(1,2)*XYZ_1_hat(2)+T_hat(1,3)*XYZ_1_hat(3)+T_hat(1,4)))...
                        /(T_hat(3,1)*XYZ_1_hat(1)+T_hat(3,2)*XYZ_1_hat(2)+T_hat(3,3)*XYZ_1_hat(3)+T_hat(3,4))^2;
            dY1_dlA=sin(sample_alpha(i)+alpha1_hat);
            dxibar1_dlA=dxibar1_dX1*dX1_dlA+dxibar1_dY1*dY1_dlA;
            dyibar1_dX1=(T_hat(2,1)*(T_hat(3,1)*XYZ_1_hat(1)+T_hat(3,2)*XYZ_1_hat(2)+...
                        T_hat(3,3)*XYZ_1_hat(3)+T_hat(3,4))-T_hat(3,1)*(T_hat(2,1)*XYZ_1_hat(1)+...
                        T_hat(2,2)*XYZ_1_hat(2)+T_hat(2,3)*XYZ_1_hat(3)+T_hat(2,4)))...
                        /(T_hat(3,1)*XYZ_1_hat(1)+T_hat(3,2)*XYZ_1_hat(2)+T_hat(3,3)*XYZ_1_hat(3)+T_hat(3,4))^2;        
            dyibar1_dY1=(T_hat(2,2)*(T_hat(3,1)*XYZ_1_hat(1)+T_hat(3,2)*XYZ_1_hat(2)+...
                        T_hat(3,3)*XYZ_1_hat(3)+T_hat(3,4))-T_hat(3,2)*(T_hat(2,1)*XYZ_1_hat(1)+...
                        T_hat(2,2)*XYZ_1_hat(2)+T_hat(2,3)*XYZ_1_hat(3)+T_hat(2,4)))...
                        /(T_hat(3,1)*XYZ_1_hat(1)+T_hat(3,2)*XYZ_1_hat(2)+T_hat(3,3)*XYZ_1_hat(3)+T_hat(3,4))^2;        
            dyibar1_dlA=dyibar1_dX1*dX1_dlA+dyibar1_dY1*dY1_dlA;
            dxdbar1_dlA=dxdbar1_dxibar1*dxibar1_dlA+dxdbar1_dyibar1*dyibar1_dlA;
            dX1_dlB=0;
            dY1_dlB=0;
            dxibar1_dlB=dxibar1_dX1*dX1_dlB+dxibar1_dY1*dY1_dlB;
            dyibar1_dlB=dyibar1_dX1*dX1_dlB+dyibar1_dY1*dY1_dlB;
            dxdbar1_dlB=dxdbar1_dxibar1*dxibar1_dlB+dxdbar1_dyibar1*dyibar1_dlB;
            dX1_dlC=0;
            dY1_dlC=0;
            dxibar1_dlC=dxibar1_dX1*dX1_dlC+dxibar1_dY1*dY1_dlC;
            dyibar1_dlC=dyibar1_dX1*dX1_dlC+dyibar1_dY1*dY1_dlC;
            dxdbar1_dlC=dxdbar1_dxibar1*dxibar1_dlC+dxdbar1_dyibar1*dyibar1_dlC;
            dX1_dl2=0;
            dY1_dl2=0;
            dxibar1_dl2=dxibar1_dX1*dX1_dl2+dxibar1_dY1*dY1_dl2;
            dyibar1_dl2=dyibar1_dX1*dX1_dl2+dyibar1_dY1*dY1_dl2;
            dxdbar1_dl2=dxdbar1_dxibar1*dxibar1_dl2+dxdbar1_dyibar1*dyibar1_dl2;
            dX1_dalpha1=-lA_hat*sin(sample_alpha(i)+alpha1_hat);
            dY1_dalpha1=lA_hat*cos(sample_alpha(i)+alpha1_hat);
            dxibar1_dalpha1=dxibar1_dX1*dX1_dalpha1+dxibar1_dY1*dY1_dalpha1;
            dyibar1_dalpha1=dyibar1_dX1*dX1_dalpha1+dyibar1_dY1*dY1_dalpha1;
            dxdbar1_dalpha1=dxdbar1_dxibar1*dxibar1_dalpha1+dxdbar1_dyibar1*dyibar1_dalpha1;
            dX1_dbeita1=0;
            dY1_dbeita1=0;
            dxibar1_dbeita1=dxibar1_dX1*dX1_dbeita1+dxibar1_dY1*dY1_dbeita1;
            dyibar1_dbeita1=dyibar1_dX1*dX1_dbeita1+dyibar1_dY1*dY1_dbeita1;
            dxdbar1_dbeita1=dxdbar1_dxibar1*dxibar1_dbeita1+dxdbar1_dyibar1*dyibar1_dbeita1;
            dX1_dgama1=0;
            dY1_dgama1=0;
            dxibar1_dgama1=dxibar1_dX1*dX1_dgama1+dxibar1_dY1*dY1_dgama1;
            dyibar1_dgama1=dyibar1_dX1*dX1_dgama1+dyibar1_dY1*dY1_dgama1;
            dxdbar1_dgama1=dxdbar1_dxibar1*dxibar1_dgama1+dxdbar1_dyibar1*dyibar1_dgama1;
            dxibar1_dZ1=(T_hat(1,3)*(T_hat(3,1)*XYZ_1_hat(1)+T_hat(3,2)*XYZ_1_hat(2)+T_hat(3,3)*XYZ_1_hat(3)+T_hat(3,4))-...
                         T_hat(3,3)*(T_hat(1,1)*XYZ_1_hat(1)+T_hat(1,2)*XYZ_1_hat(2)+T_hat(1,3)*XYZ_1_hat(3)+T_hat(1,4)))/...
                        (T_hat(3,1)*XYZ_1_hat(1)+T_hat(3,2)*XYZ_1_hat(2)+T_hat(3,3)*XYZ_1_hat(3)+T_hat(3,4))^2;     
            dyibar1_dZ1=(T_hat(2,3)*(T_hat(3,1)*XYZ_1_hat(1)+T_hat(3,2)*XYZ_1_hat(2)+T_hat(3,3)*XYZ_1_hat(3)+T_hat(3,4))-...
                         T_hat(3,3)*(T_hat(2,1)*XYZ_1_hat(1)+T_hat(2,2)*XYZ_1_hat(2)+T_hat(2,3)*XYZ_1_hat(3)+T_hat(2,4)))/...
                        (T_hat(3,1)*XYZ_1_hat(1)+T_hat(3,2)*XYZ_1_hat(2)+T_hat(3,3)*XYZ_1_hat(3)+T_hat(3,4))^2; 
            dxdbar1_dZ1=dxdbar1_dxibar1*dxibar1_dZ1+dxdbar1_dyibar1*dyibar1_dZ1;
            dxibar1_dZ2=0;
            dyibar1_dZ2=0;
            dxdbar1_dZ2=dxdbar1_dxibar1*dxibar1_dZ2+dxdbar1_dyibar1*dyibar1_dZ2;
            dxibar1_dZ3=0;
            dyibar1_dZ3=0;
            dxdbar1_dZ3=dxdbar1_dxibar1*dxibar1_dZ3+dxdbar1_dyibar1*dyibar1_dZ3;        
            du1_dM=fx_hat*[dxdbar1_dlA dxdbar1_dlB dxdbar1_dlC dxdbar1_dalpha1 ...
                           dxdbar1_dbeita1 dxdbar1_dgama1 dxdbar1_dZ1 dxdbar1_dZ2 dxdbar1_dZ3];  
            dydbar1_dlA=dydbar1_dxibar1*dxibar1_dlA+dydbar1_dyibar1*dyibar1_dlA;
            dydbar1_dlB=dydbar1_dxibar1*dxibar1_dlB+dydbar1_dyibar1*dyibar1_dlB;
            dydbar1_dlC=dydbar1_dxibar1*dxibar1_dlC+dydbar1_dyibar1*dyibar1_dlC;
            dydbar1_dalpha1=dydbar1_dxibar1*dxibar1_dalpha1+dydbar1_dyibar1*dyibar1_dalpha1;
            dydbar1_dbeita1=dydbar1_dxibar1*dxibar1_dbeita1+dydbar1_dyibar1*dyibar1_dbeita1;
            dydbar1_dgama1=dydbar1_dxibar1*dxibar1_dgama1+dydbar1_dyibar1*dyibar1_dgama1;
            dydbar1_dZ1=dydbar1_dxibar1*dxibar1_dZ1+dydbar1_dyibar1*dyibar1_dZ1;
            dydbar1_dZ2=dydbar1_dxibar1*dxibar1_dZ2+dydbar1_dyibar1*dyibar1_dZ2;
            dydbar1_dZ3=dydbar1_dxibar1*dxibar1_dZ3+dydbar1_dyibar1*dyibar1_dZ3;
            dv1_dM=fy_hat*[dydbar1_dlA dydbar1_dlB dydbar1_dlC dydbar1_dalpha1 ...
                           dydbar1_dbeita1 dydbar1_dgama1 dydbar1_dZ1 dydbar1_dZ2 dydbar1_dZ3];
            dxibar2_dX2=(T_hat(1,1)*(T_hat(3,1)*XYZ_2_hat(1)+T_hat(3,2)*XYZ_2_hat(2)+...
                        T_hat(3,3)*XYZ_2_hat(3)+T_hat(3,4))-T_hat(3,1)*(T_hat(1,1)*XYZ_2_hat(1)+...
                        T_hat(1,2)*XYZ_2_hat(2)+T_hat(1,3)*XYZ_2_hat(3)+T_hat(1,4)))...
                        /(T_hat(3,1)*XYZ_2_hat(1)+T_hat(3,2)*XYZ_2_hat(2)+T_hat(3,3)*XYZ_2_hat(3)+T_hat(3,4))^2;
            dX2_dlA=0;
            dxibar2_dY2=(T_hat(1,2)*(T_hat(3,1)*XYZ_2_hat(1)+T_hat(3,2)*XYZ_2_hat(2)+...
                        T_hat(3,3)*XYZ_2_hat(3)+T_hat(3,4))-T_hat(3,2)*(T_hat(1,1)*XYZ_2_hat(1)+...
                        T_hat(1,2)*XYZ_2_hat(2)+T_hat(1,3)*XYZ_2_hat(3)+T_hat(1,4)))...
                        /(T_hat(3,1)*XYZ_2_hat(1)+T_hat(3,2)*XYZ_2_hat(2)+T_hat(3,3)*XYZ_2_hat(3)+T_hat(3,4))^2;
            dY2_dlA=0;
            dxibar2_dlA=dxibar2_dX2*dX2_dlA+dxibar2_dY2*dY2_dlA;
            dyibar2_dX2=(T_hat(2,1)*(T_hat(3,1)*XYZ_2_hat(1)+T_hat(3,2)*XYZ_2_hat(2)+...
                        T_hat(3,3)*XYZ_2_hat(3)+T_hat(3,4))-T_hat(3,1)*(T_hat(2,1)*XYZ_2_hat(1)+...
                        T_hat(2,2)*XYZ_2_hat(2)+T_hat(2,3)*XYZ_2_hat(3)+T_hat(2,4)))...
                        /(T_hat(3,1)*XYZ_2_hat(1)+T_hat(3,2)*XYZ_2_hat(2)+T_hat(3,3)*XYZ_2_hat(3)+T_hat(3,4))^2;        
            dyibar2_dY2=(T_hat(2,2)*(T_hat(3,1)*XYZ_2_hat(1)+T_hat(3,2)*XYZ_2_hat(2)+...
                        T_hat(3,3)*XYZ_2_hat(3)+T_hat(3,4))-T_hat(3,2)*(T_hat(2,1)*XYZ_2_hat(1)+...
                        T_hat(2,2)*XYZ_2_hat(2)+T_hat(2,3)*XYZ_2_hat(3)+T_hat(2,4)))...
                        /(T_hat(3,1)*XYZ_2_hat(1)+T_hat(3,2)*XYZ_2_hat(2)+T_hat(3,3)*XYZ_2_hat(3)+T_hat(3,4))^2;        
            dyibar2_dlA=dyibar2_dX2*dX2_dlA+dyibar2_dY2*dY2_dlA;
            dxdbar2_dlA=dxdbar2_dxibar2*dxibar2_dlA+dxdbar2_dyibar2*dyibar2_dlA;
            dX2_dlB=cos(sample_alpha(i)+sample_beita(i)+beita1_hat);
            dY2_dlB=sin(sample_alpha(i)+sample_beita(i)+beita1_hat);
            dxibar2_dlB=dxibar2_dX2*dX2_dlB+dxibar2_dY2*dY2_dlB;
            dyibar2_dlB=dyibar2_dX2*dX2_dlB+dyibar2_dY2*dY2_dlB;
            dxdbar2_dlB=dxdbar2_dxibar2*dxibar2_dlB+dxdbar2_dyibar2*dyibar2_dlB;
            dX2_dlC=0;
            dY2_dlC=0;
            dxibar2_dlC=dxibar2_dX2*dX2_dlC+dxibar2_dY2*dY2_dlC;
            dyibar2_dlC=dyibar2_dX2*dX2_dlC+dyibar2_dY2*dY2_dlC;
            dxdbar2_dlC=dxdbar2_dxibar2*dxibar2_dlC+dxdbar2_dyibar2*dyibar2_dlC;
            dX2_dalpha1=0;
            dY2_dalpha1=0;
            dxibar2_dalpha1=dxibar2_dX2*dX2_dalpha1+dxibar2_dY2*dY2_dalpha1;
            dyibar2_dalpha1=dyibar2_dX2*dX2_dalpha1+dyibar2_dY2*dY2_dalpha1;
            dxdbar2_dalpha1=dxdbar2_dxibar2*dxibar2_dalpha1+dxdbar2_dyibar2*dyibar2_dalpha1;
            dX2_dbeita1=-lB_hat*sin(sample_alpha(i)+sample_beita(i)+beita1_hat);
            dY2_dbeita1=lB_hat*cos(sample_alpha(i)+sample_beita(i)+beita1_hat);
            dxibar2_dbeita1=dxibar2_dX2*dX2_dbeita1+dxibar2_dY2*dY2_dbeita1;
            dyibar2_dbeita1=dyibar2_dX2*dX2_dbeita1+dyibar2_dY2*dY2_dbeita1;
            dxdbar2_dbeita1=dxdbar2_dxibar2*dxibar2_dbeita1+dxdbar2_dyibar2*dyibar2_dbeita1;
            dX2_dgama1=0;
            dY2_dgama1=0;
            dxibar2_dgama1=dxibar2_dX2*dX2_dgama1+dxibar2_dY2*dY2_dgama1;
            dyibar2_dgama1=dyibar2_dX2*dX2_dgama1+dyibar2_dY2*dY2_dgama1;
            dxdbar2_dgama1=dxdbar2_dxibar2*dxibar2_dgama1+dxdbar2_dyibar2*dyibar2_dgama1;
            dxibar2_dZ1=0;    
            dyibar2_dZ1=0;
            dxdbar2_dZ1=dxdbar2_dxibar2*dxibar2_dZ1+dxdbar2_dyibar2*dyibar2_dZ1;
            dxibar2_dZ2=(T_hat(1,3)*(T_hat(3,1)*XYZ_2_hat(1)+T_hat(3,2)*XYZ_2_hat(2)+T_hat(3,3)*XYZ_2_hat(3)+T_hat(3,4))-...
                         T_hat(3,3)*(T_hat(1,1)*XYZ_2_hat(1)+T_hat(1,2)*XYZ_2_hat(2)+T_hat(1,3)*XYZ_2_hat(3)+T_hat(1,4)))/...
                        (T_hat(3,1)*XYZ_2_hat(1)+T_hat(3,2)*XYZ_2_hat(2)+T_hat(3,3)*XYZ_2_hat(3)+T_hat(3,4))^2;     
            dyibar2_dZ2=(T_hat(2,3)*(T_hat(3,1)*XYZ_2_hat(1)+T_hat(3,2)*XYZ_2_hat(2)+T_hat(3,3)*XYZ_2_hat(3)+T_hat(3,4))-...
                         T_hat(3,3)*(T_hat(2,1)*XYZ_2_hat(1)+T_hat(2,2)*XYZ_2_hat(2)+T_hat(2,3)*XYZ_2_hat(3)+T_hat(2,4)))/...
                        (T_hat(3,1)*XYZ_2_hat(1)+T_hat(3,2)*XYZ_2_hat(2)+T_hat(3,3)*XYZ_2_hat(3)+T_hat(3,4))^2; 
            dxdbar2_dZ2=dxdbar2_dxibar2*dxibar2_dZ2+dxdbar2_dyibar2*dyibar2_dZ2;
            dxibar2_dZ3=0;
            dyibar2_dZ3=0;
            dxdbar2_dZ3=dxdbar2_dxibar2*dxibar2_dZ3+dxdbar2_dyibar2*dyibar2_dZ3;        
            du2_dM=fx_hat*[dxdbar2_dlA dxdbar2_dlB dxdbar2_dlC dxdbar2_dalpha1 ...
                           dxdbar2_dbeita1 dxdbar2_dgama1 dxdbar2_dZ1 dxdbar2_dZ2 dxdbar2_dZ3];
            dydbar2_dlA=dydbar2_dxibar2*dxibar2_dlA+dydbar2_dyibar2*dyibar2_dlA;
            dydbar2_dlB=dydbar2_dxibar2*dxibar2_dlB+dydbar2_dyibar2*dyibar2_dlB;
            dydbar2_dlC=dydbar2_dxibar2*dxibar2_dlC+dydbar2_dyibar2*dyibar2_dlC;
            dydbar2_dalpha1=dydbar2_dxibar2*dxibar2_dalpha1+dydbar2_dyibar2*dyibar2_dalpha1;
            dydbar2_dbeita1=dydbar2_dxibar2*dxibar2_dbeita1+dydbar2_dyibar2*dyibar2_dbeita1;
            dydbar2_dgama1=dydbar2_dxibar2*dxibar2_dgama1+dydbar2_dyibar2*dyibar2_dgama1;
            dydbar2_dZ1=dydbar2_dxibar2*dxibar2_dZ1+dydbar2_dyibar2*dyibar2_dZ1;
            dydbar2_dZ2=dydbar2_dxibar2*dxibar2_dZ2+dydbar2_dyibar2*dyibar2_dZ2;
            dydbar2_dZ3=dydbar2_dxibar2*dxibar2_dZ3+dydbar2_dyibar2*dyibar2_dZ3;
            dv2_dM=fy_hat*[dydbar2_dlA dydbar2_dlB dydbar2_dlC dydbar2_dalpha1 ...
                           dydbar2_dbeita1 dydbar2_dgama1 dydbar2_dZ1 dydbar2_dZ2 dydbar2_dZ3];
            dxibar3_dX3=(T_hat(1,1)*(T_hat(3,1)*XYZ_3_hat(1)+T_hat(3,2)*XYZ_3_hat(2)+...
                        T_hat(3,3)*XYZ_3_hat(3)+T_hat(3,4))-T_hat(3,1)*(T_hat(1,1)*XYZ_3_hat(1)+...
                        T_hat(1,2)*XYZ_3_hat(2)+T_hat(1,3)*XYZ_3_hat(3)+T_hat(1,4)))...
                        /(T_hat(3,1)*XYZ_3_hat(1)+T_hat(3,2)*XYZ_3_hat(2)+T_hat(3,3)*XYZ_3_hat(3)+T_hat(3,4))^2;
            dX3_dlA=0;
            dxibar3_dY3=(T_hat(1,2)*(T_hat(3,1)*XYZ_3_hat(1)+T_hat(3,2)*XYZ_3_hat(2)+...
                        T_hat(3,3)*XYZ_3_hat(3)+T_hat(3,4))-T_hat(3,2)*(T_hat(1,1)*XYZ_3_hat(1)+...
                        T_hat(1,2)*XYZ_3_hat(2)+T_hat(1,3)*XYZ_3_hat(3)+T_hat(1,4)))...
                        /(T_hat(3,1)*XYZ_3_hat(1)+T_hat(3,2)*XYZ_3_hat(2)+T_hat(3,3)*XYZ_3_hat(3)+T_hat(3,4))^2;
            dY3_dlA=0;
            dxibar3_dlA=dxibar3_dX3*dX3_dlA+dxibar3_dY3*dY3_dlA;
            dyibar3_dX3=(T_hat(2,1)*(T_hat(3,1)*XYZ_3_hat(1)+T_hat(3,2)*XYZ_3_hat(2)+...
                        T_hat(3,3)*XYZ_3_hat(3)+T_hat(3,4))-T_hat(3,1)*(T_hat(2,1)*XYZ_3_hat(1)+...
                        T_hat(2,2)*XYZ_3_hat(2)+T_hat(2,3)*XYZ_3_hat(3)+T_hat(2,4)))...
                        /(T_hat(3,1)*XYZ_3_hat(1)+T_hat(3,2)*XYZ_3_hat(2)+T_hat(3,3)*XYZ_3_hat(3)+T_hat(3,4))^2;        
            dyibar3_dY3=(T_hat(2,2)*(T_hat(3,1)*XYZ_3_hat(1)+T_hat(3,2)*XYZ_3_hat(2)+...
                        T_hat(3,3)*XYZ_3_hat(3)+T_hat(3,4))-T_hat(3,2)*(T_hat(2,1)*XYZ_3_hat(1)+...
                        T_hat(2,2)*XYZ_3_hat(2)+T_hat(2,3)*XYZ_3_hat(3)+T_hat(2,4)))...
                        /(T_hat(3,1)*XYZ_3_hat(1)+T_hat(3,2)*XYZ_3_hat(2)+T_hat(3,3)*XYZ_3_hat(3)+T_hat(3,4))^2;        
            dyibar3_dlA=dyibar3_dX3*dX3_dlA+dyibar3_dY3*dY3_dlA;
            dxdbar3_dlA=dxdbar3_dxibar3*dxibar3_dlA+dxdbar3_dyibar3*dyibar3_dlA;
            dX3_dlB=0;
            dY3_dlB=0;
            dxibar3_dlB=dxibar3_dX3*dX3_dlB+dxibar3_dY3*dY3_dlB;
            dyibar3_dlB=dyibar3_dX3*dX3_dlB+dyibar3_dY3*dY3_dlB;
            dxdbar3_dlB=dxdbar3_dxibar3*dxibar3_dlB+dxdbar3_dyibar3*dyibar3_dlB;
            dX3_dlC=cos(sample_alpha(i)+sample_beita(i)+sample_gama(i)+gama1_hat);
            dY3_dlC=sin(sample_alpha(i)+sample_beita(i)+sample_gama(i)+gama1_hat);
            dxibar3_dlC=dxibar3_dX3*dX3_dlC+dxibar3_dY3*dY3_dlC;
            dyibar3_dlC=dyibar3_dX3*dX3_dlC+dyibar3_dY3*dY3_dlC;
            dxdbar3_dlC=dxdbar3_dxibar3*dxibar3_dlC+dxdbar3_dyibar3*dyibar3_dlC;
            dX3_dalpha1=0;
            dY3_dalpha1=0;
            dxibar3_dalpha1=dxibar3_dX3*dX3_dalpha1+dxibar3_dY3*dY3_dalpha1;
            dyibar3_dalpha1=dyibar3_dX3*dX3_dalpha1+dyibar3_dY3*dY3_dalpha1;
            dxdbar3_dalpha1=dxdbar3_dxibar3*dxibar3_dalpha1+dxdbar3_dyibar3*dyibar3_dalpha1;
            dX3_dbeita1=0;
            dY3_dbeita1=0;
            dxibar3_dbeita1=dxibar3_dX3*dX3_dbeita1+dxibar3_dY3*dY3_dbeita1;
            dyibar3_dbeita1=dyibar3_dX3*dX3_dbeita1+dyibar3_dY3*dY3_dbeita1;
            dxdbar3_dbeita1=dxdbar3_dxibar3*dxibar3_dbeita1+dxdbar3_dyibar3*dyibar3_dbeita1;
            dX3_dgama1=-lC_hat*sin(sample_alpha(i)+sample_beita(i)+sample_gama(i)+gama1_hat);
            dY3_dgama1=lC_hat*cos(sample_alpha(i)+sample_beita(i)+sample_gama(i)+gama1_hat);
            dxibar3_dgama1=dxibar3_dX3*dX3_dgama1+dxibar3_dY3*dY3_dgama1;
            dyibar3_dgama1=dyibar3_dX3*dX3_dgama1+dyibar3_dY3*dY3_dgama1;
            dxdbar3_dgama1=dxdbar3_dxibar3*dxibar3_dgama1+dxdbar3_dyibar3*dyibar3_dgama1;
            dxibar3_dZ1=0;    
            dyibar3_dZ1=0;
            dxdbar3_dZ1=dxdbar3_dxibar3*dxibar3_dZ1+dxdbar3_dyibar3*dyibar3_dZ1;
            dxibar3_dZ2=0;
            dyibar3_dZ2=0;
            dxdbar3_dZ2=dxdbar3_dxibar3*dxibar3_dZ2+dxdbar3_dyibar3*dyibar3_dZ2;
            dxibar3_dZ3=(T_hat(1,3)*(T_hat(3,1)*XYZ_3_hat(1)+T_hat(3,2)*XYZ_3_hat(2)+T_hat(3,3)*XYZ_3_hat(3)+T_hat(3,4))-...
                         T_hat(3,3)*(T_hat(1,1)*XYZ_3_hat(1)+T_hat(1,2)*XYZ_3_hat(2)+T_hat(1,3)*XYZ_3_hat(3)+T_hat(1,4)))/...
                        (T_hat(3,1)*XYZ_3_hat(1)+T_hat(3,2)*XYZ_3_hat(2)+T_hat(3,3)*XYZ_3_hat(3)+T_hat(3,4))^2;           
            dyibar3_dZ3=(T_hat(2,3)*(T_hat(3,1)*XYZ_3_hat(1)+T_hat(3,2)*XYZ_3_hat(2)+T_hat(3,3)*XYZ_3_hat(3)+T_hat(3,4))-...
                         T_hat(3,3)*(T_hat(2,1)*XYZ_3_hat(1)+T_hat(2,2)*XYZ_3_hat(2)+T_hat(2,3)*XYZ_3_hat(3)+T_hat(2,4)))/...
                        (T_hat(3,1)*XYZ_3_hat(1)+T_hat(3,2)*XYZ_3_hat(2)+T_hat(3,3)*XYZ_3_hat(3)+T_hat(3,4))^2;
            dxdbar3_dZ3=dxdbar3_dxibar3*dxibar3_dZ3+dxdbar3_dyibar3*dyibar3_dZ3;
            du3_dM=fx_hat*[dxdbar3_dlA dxdbar3_dlB dxdbar3_dlC dxdbar3_dalpha1 ...
                           dxdbar3_dbeita1 dxdbar3_dgama1 dxdbar3_dZ1 dxdbar3_dZ2 dxdbar3_dZ3];   
            dydbar3_dlA=dydbar3_dxibar3*dxibar3_dlA+dydbar3_dyibar3*dyibar3_dlA;
            dydbar3_dlB=dydbar3_dxibar3*dxibar3_dlB+dydbar3_dyibar3*dyibar3_dlB;
            dydbar3_dlC=dydbar3_dxibar3*dxibar3_dlC+dydbar3_dyibar3*dyibar3_dlC;
            dydbar3_dalpha1=dydbar3_dxibar3*dxibar3_dalpha1+dydbar3_dyibar3*dyibar3_dalpha1;
            dydbar3_dbeita1=dydbar3_dxibar3*dxibar3_dbeita1+dydbar3_dyibar3*dyibar3_dbeita1;
            dydbar3_dgama1=dydbar3_dxibar3*dxibar3_dgama1+dydbar3_dyibar3*dyibar3_dgama1;
            dydbar3_dZ1=dydbar3_dxibar3*dxibar3_dZ1+dydbar3_dyibar3*dyibar3_dZ1;
            dydbar3_dZ2=dydbar3_dxibar3*dxibar3_dZ2+dydbar3_dyibar3*dyibar3_dZ2;
            dydbar3_dZ3=dydbar3_dxibar3*dxibar3_dZ3+dydbar3_dyibar3*dyibar3_dZ3;
            dv3_dM=fy_hat*[dydbar3_dlA dydbar3_dlB dydbar3_dlC dydbar3_dalpha1 ...
                           dydbar3_dbeita1 dydbar3_dgama1 dydbar3_dZ1 dydbar3_dZ2 dydbar3_dZ3];
            JM(6*(i-1)+1:6*(i-1)+6,:)=[du1_dM;dv1_dM;du2_dM;dv2_dM;du3_dM;dv3_dM];    

        end

        %The complete Jacobian matrix J
        J=[JN JT JD JM];

        %Parameter update
        step=-inv(J'*J+u*eye(24,24))*J'*E;
        ParaLThisTimeNew=ParaL_hat+step;
        ParaLAll(:,t)=ParaLThisTimeNew;

        %Residual of this iteration
        Esum2(t-1,1)=sqrt(sum(E.^2)/length(E));

        %display
        disp(['RansacTime=' num2str(k) '   IterationsTime=' num2str(t) '   AverageResidual=' num2str(Esum2(t-1,1)) ]);

        % Determine if termination conditions are met
        if t>10
            if (abs(Esum2(t-1,1)-Esum2(t-2,1))<ErrorTolerance && abs(Esum2(t-2,1)-Esum2(t-3,1))<ErrorTolerance && abs(Esum2(t-3,1)-Esum2(t-4,1))<ErrorTolerance)
                disp(['Reached ErrorTolerance']);
                break;
            end
        end   
    end
    
    %% Internal point update
    % Calculate residuals from all points to the model
    EAve = f_forward(ParaLThisTimeNew,alpha,beita,gama,u1,v1,u2,v2,u3,v3);
    % Determine interior points based on threshold
    inliersPosition = find(EAve < Ti);
    if length(inliersPosition) > length(bestInliersPosition)
        bestInliersPosition = inliersPosition;
    end 
end


%% Update parameters using inliers
ErrorTolerance=10^-9;
Nu=length(bestInliersPosition);
ParaL_hat=zeros(24,1);
ParaLAll=zeros(24,NLM);
ParaLAll(:,1)=ParaL0;
E=zeros(6*Nu,1);
JN=zeros(6*Nu,4);
JT=zeros(6*Nu,6);
JD=zeros(6*Nu,5);
JM=zeros(6*Nu,9);
JF=zeros(26,NLM-1);
u=0.1;
Esum2=zeros(NLM-1,1);

for t=2:NLM
    ParaL_hat=ParaLAll(:,t-1);
    fx_hat=ParaL_hat(1);
    u0_hat=ParaL_hat(2);
    fy_hat=ParaL_hat(3);
    v0_hat=ParaL_hat(4);
    rou1_hat=ParaL_hat(5);
    rou2_hat=ParaL_hat(6);
    rou3_hat=ParaL_hat(7);
    fai1_hat=ParaL_hat(8);
    fai2_hat=ParaL_hat(9);
    fai3_hat=ParaL_hat(10);
    k1_hat=ParaL_hat(11);
    k2_hat=ParaL_hat(12);
    p1_hat=ParaL_hat(13);
    p2_hat=ParaL_hat(14);
    k3_hat=ParaL_hat(15);
    lA_hat=ParaL_hat(16);
    lB_hat=ParaL_hat(17);
    lC_hat=ParaL_hat(18);
    alpha1_hat=ParaL_hat(19);
    beita1_hat=ParaL_hat(20);
    gama1_hat=ParaL_hat(21);
    Z1_hat=ParaL_hat(22);
    Z2_hat=ParaL_hat(23);
    Z3_hat=ParaL_hat(24);
    
    K_hat=[fx_hat 0 u0_hat;0 fy_hat v0_hat;0 0 1];
    
    T_hat=roufai2T([rou1_hat;rou2_hat;rou3_hat],[fai1_hat;fai2_hat;fai3_hat]);
    
    for i=1:Nu
        
        XYZ_1_hat=[lA_hat*cos(alpha(bestInliersPosition(i))+alpha1_hat);...
                   lA_hat*sin(alpha(bestInliersPosition(i))+alpha1_hat);Z1_hat];
        XYZ_2_hat=[l1*cos(alpha(bestInliersPosition(i)))+lB_hat*cos(alpha(bestInliersPosition(i))+beita(bestInliersPosition(i))+beita1_hat);...
                   l1*sin(alpha(bestInliersPosition(i)))+lB_hat*sin(alpha(bestInliersPosition(i))+beita(bestInliersPosition(i))+beita1_hat);...
                   Z2_hat];
        XYZ_3_hat=[l1*cos(alpha(bestInliersPosition(i)))+l2*cos(alpha(bestInliersPosition(i))+beita(bestInliersPosition(i)))+...
                   lC_hat*cos(alpha(bestInliersPosition(i))+beita(bestInliersPosition(i))+gama(bestInliersPosition(i))+gama1_hat);...
                   l1*sin(alpha(bestInliersPosition(i)))+l2*sin(alpha(bestInliersPosition(i))+beita(bestInliersPosition(i)))+...
                   lC_hat*sin(alpha(bestInliersPosition(i))+beita(bestInliersPosition(i))+gama(bestInliersPosition(i))+gama1_hat);...
                   Z3_hat];
        
        XcYcZc_1_hat=T_hat*[XYZ_1_hat;1];
        XcYcZc_2_hat=T_hat*[XYZ_2_hat;1];
        XcYcZc_3_hat=T_hat*[XYZ_3_hat;1];
        
        xi_bar_1_hat=XcYcZc_1_hat(1)/XcYcZc_1_hat(3);
        yi_bar_1_hat=XcYcZc_1_hat(2)/XcYcZc_1_hat(3);
        r_1_hat=sqrt(xi_bar_1_hat^2+yi_bar_1_hat^2);
        xi_bar_2_hat=XcYcZc_2_hat(1)/XcYcZc_2_hat(3);
        yi_bar_2_hat=XcYcZc_2_hat(2)/XcYcZc_2_hat(3);
        r_2_hat=sqrt(xi_bar_2_hat^2+yi_bar_2_hat^2);
        xi_bar_3_hat=XcYcZc_3_hat(1)/XcYcZc_3_hat(3);
        yi_bar_3_hat=XcYcZc_3_hat(2)/XcYcZc_3_hat(3);
        r_3_hat=sqrt(xi_bar_3_hat^2+yi_bar_3_hat^2);
        
        xd_bar_1_hat=xi_bar_1_hat*(1+k1_hat*r_1_hat^2+k2_hat*r_1_hat^4+...
                     k3_hat*r_1_hat^6)+2*p1_hat*xi_bar_1_hat*yi_bar_1_hat+...
                     p2_hat*(r_1_hat^2+2*xi_bar_1_hat^2);
        yd_bar_1_hat=yi_bar_1_hat*(1+k1_hat*r_1_hat^2+k2_hat*r_1_hat^4+...
                     k3_hat*r_1_hat^6)+2*p2_hat*xi_bar_1_hat*yi_bar_1_hat+...
                     p1_hat*(r_1_hat^2+2*yi_bar_1_hat^2);
        xd_bar_2_hat=xi_bar_2_hat*(1+k1_hat*r_2_hat^2+k2_hat*r_2_hat^4+...
                     k3_hat*r_2_hat^6)+2*p1_hat*xi_bar_2_hat*yi_bar_2_hat+...
                     p2_hat*(r_2_hat^2+2*xi_bar_2_hat^2);
        yd_bar_2_hat=yi_bar_2_hat*(1+k1_hat*r_2_hat^2+k2_hat*r_2_hat^4+...
                     k3_hat*r_2_hat^6)+2*p2_hat*xi_bar_2_hat*yi_bar_2_hat+...
                     p1_hat*(r_2_hat^2+2*yi_bar_2_hat^2);
        xd_bar_3_hat=xi_bar_3_hat*(1+k1_hat*r_3_hat^2+k2_hat*r_3_hat^4+...
                     k3_hat*r_3_hat^6)+2*p1_hat*xi_bar_3_hat*yi_bar_3_hat+...
                     p2_hat*(r_3_hat^2+2*xi_bar_3_hat^2);
        yd_bar_3_hat=yi_bar_3_hat*(1+k1_hat*r_3_hat^2+k2_hat*r_3_hat^4+...
                     k3_hat*r_3_hat^6)+2*p2_hat*xi_bar_3_hat*yi_bar_3_hat+...
                     p1_hat*(r_3_hat^2+2*yi_bar_3_hat^2);       
                 
        UV_1_hat=K_hat*[xd_bar_1_hat;yd_bar_1_hat;1];
        UV_2_hat=K_hat*[xd_bar_2_hat;yd_bar_2_hat;1];
        UV_3_hat=K_hat*[xd_bar_3_hat;yd_bar_3_hat;1];
        
        E(6*(i-1)+1,1)=UV_1_hat(1)-u1(bestInliersPosition(i));
        E(6*(i-1)+2,1)=UV_1_hat(2)-v1(bestInliersPosition(i));
        E(6*(i-1)+3,1)=UV_2_hat(1)-u2(bestInliersPosition(i));
        E(6*(i-1)+4,1)=UV_2_hat(2)-v2(bestInliersPosition(i));
        E(6*(i-1)+5,1)=UV_3_hat(1)-u3(bestInliersPosition(i));
        E(6*(i-1)+6,1)=UV_3_hat(2)-v3(bestInliersPosition(i));
        
        JN(6*(i-1)+1:6*(i-1)+6,:)=[xd_bar_1_hat 1 0 0;0 0 yd_bar_1_hat 1;...
                                   xd_bar_2_hat 1 0 0;0 0 yd_bar_2_hat 1;...
                                   xd_bar_3_hat 1 0 0;0 0 yd_bar_3_hat 1;];
        
        dxdbar1_dxibar1=1+3*k1_hat*xi_bar_1_hat^2+k1_hat*yi_bar_1_hat^2+5*k2_hat*xi_bar_1_hat^4+...
                        k2_hat*yi_bar_1_hat^4+6*k2_hat*yi_bar_1_hat^2*xi_bar_1_hat^2+...
                        7*k3_hat*xi_bar_1_hat^6+3*k3_hat*xi_bar_1_hat^2*yi_bar_1_hat^4+...
                        10*k3_hat*xi_bar_1_hat^4*yi_bar_1_hat^2+5*k3_hat*yi_bar_1_hat^2*xi_bar_1_hat^4+...
                        k3_hat*yi_bar_1_hat^6+6*k3_hat*xi_bar_1_hat^2*yi_bar_1_hat^4+2*p1_hat*yi_bar_1_hat+...
                        +6*p2_hat*xi_bar_1_hat;
        dxdbar1_dyibar1=2*k1_hat*xi_bar_1_hat^1*yi_bar_1_hat^1+4*k2_hat*xi_bar_1_hat^1*yi_bar_1_hat^3+...
                        4*k2_hat*xi_bar_1_hat^3*yi_bar_1_hat^1+4*k3_hat*xi_bar_1_hat^3*yi_bar_1_hat^3+...
                        4*k3_hat*xi_bar_1_hat^5*yi_bar_1_hat^1+2*k3_hat*xi_bar_1_hat^5*yi_bar_1_hat^1+...
                        6*k3_hat*xi_bar_1_hat^1*yi_bar_1_hat^5+8*k3_hat*xi_bar_1_hat^3*yi_bar_1_hat^3+...
                        2*p1_hat*xi_bar_1_hat+2*p2_hat*yi_bar_1_hat;
        dydbar1_dxibar1=2*k1_hat*xi_bar_1_hat^1*yi_bar_1_hat^1+4*k2_hat*xi_bar_1_hat^3*yi_bar_1_hat^1+...
                        4*k2_hat*xi_bar_1_hat^1*yi_bar_1_hat^3+6*k3_hat*xi_bar_1_hat^5*yi_bar_1_hat^1+...
                        2*k3_hat*xi_bar_1_hat^1*yi_bar_1_hat^5+8*k3_hat*xi_bar_1_hat^3*yi_bar_1_hat^3+...
                        4*k3_hat*xi_bar_1_hat^3*yi_bar_1_hat^3+4*k3_hat*xi_bar_1_hat^1*yi_bar_1_hat^5+...
                        2*p2_hat*yi_bar_1_hat+2*p1_hat*xi_bar_1_hat;
        dydbar1_dyibar1=1+3*k1_hat*yi_bar_1_hat^2+k1_hat*xi_bar_1_hat^2+5*k2_hat*yi_bar_1_hat^4+...
                        k2_hat*xi_bar_1_hat^4+6*k2_hat*yi_bar_1_hat^2*xi_bar_1_hat^2+...
                        k3_hat*xi_bar_1_hat^6+5*k3_hat*xi_bar_1_hat^2*yi_bar_1_hat^4+...
                        6*k3_hat*xi_bar_1_hat^4*yi_bar_1_hat^2+3*k3_hat*yi_bar_1_hat^2*xi_bar_1_hat^4+...
                        7*k3_hat*yi_bar_1_hat^6+10*k3_hat*xi_bar_1_hat^2*yi_bar_1_hat^4+2*p2_hat*xi_bar_1_hat+...
                        +6*p1_hat*yi_bar_1_hat;
        dxdbar2_dxibar2=1+3*k1_hat*xi_bar_2_hat^2+k1_hat*yi_bar_2_hat^2+5*k2_hat*xi_bar_2_hat^4+...
                        k2_hat*yi_bar_2_hat^4+6*k2_hat*yi_bar_2_hat^2*xi_bar_2_hat^2+...
                        7*k3_hat*xi_bar_2_hat^6+3*k3_hat*xi_bar_2_hat^2*yi_bar_2_hat^4+...
                        10*k3_hat*xi_bar_2_hat^4*yi_bar_2_hat^2+5*k3_hat*yi_bar_2_hat^2*xi_bar_2_hat^4+...
                        k3_hat*yi_bar_2_hat^6+6*k3_hat*xi_bar_2_hat^2*yi_bar_2_hat^4+2*p1_hat*yi_bar_2_hat+...
                        +6*p2_hat*xi_bar_2_hat;
        dxdbar2_dyibar2=2*k1_hat*xi_bar_2_hat^1*yi_bar_2_hat^1+4*k2_hat*xi_bar_2_hat^1*yi_bar_2_hat^3+...
                        4*k2_hat*xi_bar_2_hat^3*yi_bar_2_hat^1+4*k3_hat*xi_bar_2_hat^3*yi_bar_2_hat^3+...
                        4*k3_hat*xi_bar_2_hat^5*yi_bar_2_hat^1+2*k3_hat*xi_bar_2_hat^5*yi_bar_2_hat^1+...
                        6*k3_hat*xi_bar_2_hat^1*yi_bar_2_hat^5+8*k3_hat*xi_bar_2_hat^3*yi_bar_2_hat^3+...
                        2*p1_hat*xi_bar_2_hat+2*p2_hat*yi_bar_2_hat;
        dydbar2_dxibar2=2*k1_hat*xi_bar_2_hat^1*yi_bar_2_hat^1+4*k2_hat*xi_bar_2_hat^3*yi_bar_2_hat^1+...
                        4*k2_hat*xi_bar_2_hat^1*yi_bar_2_hat^3+6*k3_hat*xi_bar_2_hat^5*yi_bar_2_hat^1+...
                        2*k3_hat*xi_bar_2_hat^1*yi_bar_2_hat^5+8*k3_hat*xi_bar_2_hat^3*yi_bar_2_hat^3+...
                        4*k3_hat*xi_bar_2_hat^3*yi_bar_2_hat^3+4*k3_hat*xi_bar_2_hat^1*yi_bar_2_hat^5+...
                        2*p2_hat*yi_bar_2_hat+2*p1_hat*xi_bar_2_hat;
        dydbar2_dyibar2=1+3*k1_hat*yi_bar_2_hat^2+k1_hat*xi_bar_2_hat^2+5*k2_hat*yi_bar_2_hat^4+...
                        k2_hat*xi_bar_2_hat^4+6*k2_hat*yi_bar_2_hat^2*xi_bar_2_hat^2+...
                        k3_hat*xi_bar_2_hat^6+5*k3_hat*xi_bar_2_hat^2*yi_bar_2_hat^4+...
                        6*k3_hat*xi_bar_2_hat^4*yi_bar_2_hat^2+3*k3_hat*yi_bar_2_hat^2*xi_bar_2_hat^4+...
                        7*k3_hat*yi_bar_2_hat^6+10*k3_hat*xi_bar_2_hat^2*yi_bar_2_hat^4+2*p2_hat*xi_bar_2_hat+...
                        +6*p1_hat*yi_bar_2_hat;
        dxdbar3_dxibar3=1+3*k1_hat*xi_bar_3_hat^2+k1_hat*yi_bar_3_hat^2+5*k2_hat*xi_bar_3_hat^4+...
                        k2_hat*yi_bar_3_hat^4+6*k2_hat*yi_bar_3_hat^2*xi_bar_3_hat^2+...
                        7*k3_hat*xi_bar_3_hat^6+3*k3_hat*xi_bar_3_hat^2*yi_bar_3_hat^4+...
                        10*k3_hat*xi_bar_3_hat^4*yi_bar_3_hat^2+5*k3_hat*yi_bar_3_hat^2*xi_bar_3_hat^4+...
                        k3_hat*yi_bar_3_hat^6+6*k3_hat*xi_bar_3_hat^2*yi_bar_3_hat^4+2*p1_hat*yi_bar_3_hat+...
                        +6*p2_hat*xi_bar_3_hat;
        dxdbar3_dyibar3=2*k1_hat*xi_bar_3_hat^1*yi_bar_3_hat^1+4*k2_hat*xi_bar_3_hat^1*yi_bar_3_hat^3+...
                        4*k2_hat*xi_bar_3_hat^3*yi_bar_3_hat^1+4*k3_hat*xi_bar_3_hat^3*yi_bar_3_hat^3+...
                        4*k3_hat*xi_bar_3_hat^5*yi_bar_3_hat^1+2*k3_hat*xi_bar_3_hat^5*yi_bar_3_hat^1+...
                        6*k3_hat*xi_bar_3_hat^1*yi_bar_3_hat^5+8*k3_hat*xi_bar_3_hat^3*yi_bar_3_hat^3+...
                        2*p1_hat*xi_bar_3_hat+2*p2_hat*yi_bar_3_hat;
        dydbar3_dxibar3=2*k1_hat*xi_bar_3_hat^1*yi_bar_3_hat^1+4*k2_hat*xi_bar_3_hat^3*yi_bar_3_hat^1+...
                        4*k2_hat*xi_bar_3_hat^1*yi_bar_3_hat^3+6*k3_hat*xi_bar_3_hat^5*yi_bar_3_hat^1+...
                        2*k3_hat*xi_bar_3_hat^1*yi_bar_3_hat^5+8*k3_hat*xi_bar_3_hat^3*yi_bar_3_hat^3+...
                        4*k3_hat*xi_bar_3_hat^3*yi_bar_3_hat^3+4*k3_hat*xi_bar_3_hat^1*yi_bar_3_hat^5+...
                        2*p2_hat*yi_bar_3_hat+2*p1_hat*xi_bar_3_hat;
        dydbar3_dyibar3=1+3*k1_hat*yi_bar_3_hat^2+k1_hat*xi_bar_3_hat^2+5*k2_hat*yi_bar_3_hat^4+...
                        k2_hat*xi_bar_3_hat^4+6*k2_hat*yi_bar_3_hat^2*xi_bar_3_hat^2+...
                        k3_hat*xi_bar_3_hat^6+5*k3_hat*xi_bar_3_hat^2*yi_bar_3_hat^4+...
                        6*k3_hat*xi_bar_3_hat^4*yi_bar_3_hat^2+3*k3_hat*yi_bar_3_hat^2*xi_bar_3_hat^4+...
                        7*k3_hat*yi_bar_3_hat^6+10*k3_hat*xi_bar_3_hat^2*yi_bar_3_hat^4+2*p2_hat*xi_bar_3_hat+...
                        +6*p1_hat*yi_bar_3_hat;                                       
        du1_dT=[fx_hat 0]*[dxdbar1_dxibar1 dxdbar1_dyibar1;dydbar1_dxibar1 dydbar1_dyibar1]*...
               [1/XcYcZc_1_hat(3) 0 -XcYcZc_1_hat(1)/XcYcZc_1_hat(3)^2;0 1/XcYcZc_1_hat(3) -XcYcZc_1_hat(2)/XcYcZc_1_hat(3)^2]...
               *[1 0 0 0 XcYcZc_1_hat(3) -XcYcZc_1_hat(2);0 1 0 -XcYcZc_1_hat(3) 0 XcYcZc_1_hat(1);0 0 1 XcYcZc_1_hat(2) -XcYcZc_1_hat(1) 0];
        dv1_dT=[0 fy_hat]*[dxdbar1_dxibar1 dxdbar1_dyibar1;dydbar1_dxibar1 dydbar1_dyibar1]*...
               [1/XcYcZc_1_hat(3) 0 -XcYcZc_1_hat(1)/XcYcZc_1_hat(3)^2;0 1/XcYcZc_1_hat(3) -XcYcZc_1_hat(2)/XcYcZc_1_hat(3)^2]...
               *[1 0 0 0 XcYcZc_1_hat(3) -XcYcZc_1_hat(2);0 1 0 -XcYcZc_1_hat(3) 0 XcYcZc_1_hat(1);0 0 1 XcYcZc_1_hat(2) -XcYcZc_1_hat(1) 0];
        du2_dT=[fx_hat 0]*[dxdbar2_dxibar2 dxdbar2_dyibar2;dydbar2_dxibar2 dydbar2_dyibar2]*...
               [1/XcYcZc_2_hat(3) 0 -XcYcZc_2_hat(1)/XcYcZc_2_hat(3)^2;0 1/XcYcZc_2_hat(3) -XcYcZc_2_hat(2)/XcYcZc_2_hat(3)^2]...
               *[1 0 0 0 XcYcZc_2_hat(3) -XcYcZc_2_hat(2);0 1 0 -XcYcZc_2_hat(3) 0 XcYcZc_2_hat(1);0 0 1 XcYcZc_2_hat(2) -XcYcZc_2_hat(1) 0];
        dv2_dT=[0 fy_hat]*[dxdbar2_dxibar2 dxdbar2_dyibar2;dydbar2_dxibar2 dydbar2_dyibar2]*...
               [1/XcYcZc_2_hat(3) 0 -XcYcZc_2_hat(1)/XcYcZc_2_hat(3)^2;0 1/XcYcZc_2_hat(3) -XcYcZc_2_hat(2)/XcYcZc_2_hat(3)^2]...
               *[1 0 0 0 XcYcZc_2_hat(3) -XcYcZc_2_hat(2);0 1 0 -XcYcZc_2_hat(3) 0 XcYcZc_2_hat(1);0 0 1 XcYcZc_2_hat(2) -XcYcZc_2_hat(1) 0];
        du3_dT=[fx_hat 0]*[dxdbar3_dxibar3 dxdbar3_dyibar3;dydbar3_dxibar3 dydbar3_dyibar3]*...
               [1/XcYcZc_3_hat(3) 0 -XcYcZc_3_hat(1)/XcYcZc_3_hat(3)^2;0 1/XcYcZc_3_hat(3) -XcYcZc_3_hat(2)/XcYcZc_3_hat(3)^2]...
               *[1 0 0 0 XcYcZc_3_hat(3) -XcYcZc_3_hat(2);0 1 0 -XcYcZc_3_hat(3) 0 XcYcZc_3_hat(1);0 0 1 XcYcZc_3_hat(2) -XcYcZc_3_hat(1) 0];
        dv3_dT=[0 fy_hat]*[dxdbar3_dxibar3 dxdbar3_dyibar3;dydbar3_dxibar3 dydbar3_dyibar3]*...
               [1/XcYcZc_3_hat(3) 0 -XcYcZc_3_hat(1)/XcYcZc_3_hat(3)^2;0 1/XcYcZc_3_hat(3) -XcYcZc_3_hat(2)/XcYcZc_3_hat(3)^2]...
               *[1 0 0 0 XcYcZc_3_hat(3) -XcYcZc_3_hat(2);0 1 0 -XcYcZc_3_hat(3) 0 XcYcZc_3_hat(1);0 0 1 XcYcZc_3_hat(2) -XcYcZc_3_hat(1) 0];
        JT(6*(i-1)+1:6*(i-1)+6,:)=[du1_dT;dv1_dT;du2_dT;dv2_dT;du3_dT;dv3_dT];
        
        %JD雅克比矩阵的求解
        du1_dD=fx_hat*[r_1_hat^2*xi_bar_1_hat,r_1_hat^4*xi_bar_1_hat,2*xi_bar_1_hat*yi_bar_1_hat,...
                       r_1_hat^2+2*xi_bar_1_hat^2,r_1_hat^6*xi_bar_1_hat];
        dv1_dD=fy_hat*[r_1_hat^2*yi_bar_1_hat,r_1_hat^4*yi_bar_1_hat,r_1_hat^2+2*yi_bar_1_hat^2,...
                       2*xi_bar_1_hat*yi_bar_1_hat,r_1_hat^6*yi_bar_1_hat];   
        du2_dD=fx_hat*[r_2_hat^2*xi_bar_2_hat,r_2_hat^4*xi_bar_2_hat,2*xi_bar_2_hat*yi_bar_2_hat,...
                       r_2_hat^2+2*xi_bar_2_hat^2,r_2_hat^6*xi_bar_2_hat];
        dv2_dD=fy_hat*[r_2_hat^2*yi_bar_2_hat,r_2_hat^4*yi_bar_2_hat,r_2_hat^2+2*yi_bar_2_hat^2,...
                       2*xi_bar_2_hat*yi_bar_2_hat,r_2_hat^6*yi_bar_2_hat];    
        du3_dD=fx_hat*[r_3_hat^2*xi_bar_3_hat,r_3_hat^4*xi_bar_3_hat,2*xi_bar_3_hat*yi_bar_3_hat,...
                       r_3_hat^2+2*xi_bar_3_hat^2,r_3_hat^6*xi_bar_3_hat];
        dv3_dD=fy_hat*[r_3_hat^2*yi_bar_3_hat,r_3_hat^4*yi_bar_3_hat,r_3_hat^2+2*yi_bar_3_hat^2,...
                       2*xi_bar_3_hat*yi_bar_3_hat,r_3_hat^6*yi_bar_3_hat];   
        JD(6*(i-1)+1:6*(i-1)+6,:)=[du1_dD;dv1_dD;du2_dD;dv2_dD;du3_dD;dv3_dD];    
        
        dxibar1_dX1=(T_hat(1,1)*(T_hat(3,1)*XYZ_1_hat(1)+T_hat(3,2)*XYZ_1_hat(2)+...
                    T_hat(3,3)*XYZ_1_hat(3)+T_hat(3,4))-T_hat(3,1)*(T_hat(1,1)*XYZ_1_hat(1)+...
                    T_hat(1,2)*XYZ_1_hat(2)+T_hat(1,3)*XYZ_1_hat(3)+T_hat(1,4)))...
                    /(T_hat(3,1)*XYZ_1_hat(1)+T_hat(3,2)*XYZ_1_hat(2)+T_hat(3,3)*XYZ_1_hat(3)+T_hat(3,4))^2;
        dX1_dlA=cos(alpha(bestInliersPosition(i))+alpha1_hat);
        dxibar1_dY1=(T_hat(1,2)*(T_hat(3,1)*XYZ_1_hat(1)+T_hat(3,2)*XYZ_1_hat(2)+...
                    T_hat(3,3)*XYZ_1_hat(3)+T_hat(3,4))-T_hat(3,2)*(T_hat(1,1)*XYZ_1_hat(1)+...
                    T_hat(1,2)*XYZ_1_hat(2)+T_hat(1,3)*XYZ_1_hat(3)+T_hat(1,4)))...
                    /(T_hat(3,1)*XYZ_1_hat(1)+T_hat(3,2)*XYZ_1_hat(2)+T_hat(3,3)*XYZ_1_hat(3)+T_hat(3,4))^2;
        dY1_dlA=sin(alpha(bestInliersPosition(i))+alpha1_hat);
        dxibar1_dlA=dxibar1_dX1*dX1_dlA+dxibar1_dY1*dY1_dlA;
        dyibar1_dX1=(T_hat(2,1)*(T_hat(3,1)*XYZ_1_hat(1)+T_hat(3,2)*XYZ_1_hat(2)+...
                    T_hat(3,3)*XYZ_1_hat(3)+T_hat(3,4))-T_hat(3,1)*(T_hat(2,1)*XYZ_1_hat(1)+...
                    T_hat(2,2)*XYZ_1_hat(2)+T_hat(2,3)*XYZ_1_hat(3)+T_hat(2,4)))...
                    /(T_hat(3,1)*XYZ_1_hat(1)+T_hat(3,2)*XYZ_1_hat(2)+T_hat(3,3)*XYZ_1_hat(3)+T_hat(3,4))^2;        
        dyibar1_dY1=(T_hat(2,2)*(T_hat(3,1)*XYZ_1_hat(1)+T_hat(3,2)*XYZ_1_hat(2)+...
                    T_hat(3,3)*XYZ_1_hat(3)+T_hat(3,4))-T_hat(3,2)*(T_hat(2,1)*XYZ_1_hat(1)+...
                    T_hat(2,2)*XYZ_1_hat(2)+T_hat(2,3)*XYZ_1_hat(3)+T_hat(2,4)))...
                    /(T_hat(3,1)*XYZ_1_hat(1)+T_hat(3,2)*XYZ_1_hat(2)+T_hat(3,3)*XYZ_1_hat(3)+T_hat(3,4))^2;        
        dyibar1_dlA=dyibar1_dX1*dX1_dlA+dyibar1_dY1*dY1_dlA;
        dxdbar1_dlA=dxdbar1_dxibar1*dxibar1_dlA+dxdbar1_dyibar1*dyibar1_dlA;
        dX1_dlB=0;
        dY1_dlB=0;
        dxibar1_dlB=dxibar1_dX1*dX1_dlB+dxibar1_dY1*dY1_dlB;
        dyibar1_dlB=dyibar1_dX1*dX1_dlB+dyibar1_dY1*dY1_dlB;
        dxdbar1_dlB=dxdbar1_dxibar1*dxibar1_dlB+dxdbar1_dyibar1*dyibar1_dlB;
        dX1_dlC=0;
        dY1_dlC=0;
        dxibar1_dlC=dxibar1_dX1*dX1_dlC+dxibar1_dY1*dY1_dlC;
        dyibar1_dlC=dyibar1_dX1*dX1_dlC+dyibar1_dY1*dY1_dlC;
        dxdbar1_dlC=dxdbar1_dxibar1*dxibar1_dlC+dxdbar1_dyibar1*dyibar1_dlC;
        dX1_dl2=0;
        dY1_dl2=0;
        dxibar1_dl2=dxibar1_dX1*dX1_dl2+dxibar1_dY1*dY1_dl2;
        dyibar1_dl2=dyibar1_dX1*dX1_dl2+dyibar1_dY1*dY1_dl2;
        dxdbar1_dl2=dxdbar1_dxibar1*dxibar1_dl2+dxdbar1_dyibar1*dyibar1_dl2;
        dX1_dalpha1=-lA_hat*sin(alpha(bestInliersPosition(i))+alpha1_hat);
        dY1_dalpha1=lA_hat*cos(alpha(bestInliersPosition(i))+alpha1_hat);
        dxibar1_dalpha1=dxibar1_dX1*dX1_dalpha1+dxibar1_dY1*dY1_dalpha1;
        dyibar1_dalpha1=dyibar1_dX1*dX1_dalpha1+dyibar1_dY1*dY1_dalpha1;
        dxdbar1_dalpha1=dxdbar1_dxibar1*dxibar1_dalpha1+dxdbar1_dyibar1*dyibar1_dalpha1;
        dX1_dbeita1=0;
        dY1_dbeita1=0;
        dxibar1_dbeita1=dxibar1_dX1*dX1_dbeita1+dxibar1_dY1*dY1_dbeita1;
        dyibar1_dbeita1=dyibar1_dX1*dX1_dbeita1+dyibar1_dY1*dY1_dbeita1;
        dxdbar1_dbeita1=dxdbar1_dxibar1*dxibar1_dbeita1+dxdbar1_dyibar1*dyibar1_dbeita1;
        dX1_dgama1=0;
        dY1_dgama1=0;
        dxibar1_dgama1=dxibar1_dX1*dX1_dgama1+dxibar1_dY1*dY1_dgama1;
        dyibar1_dgama1=dyibar1_dX1*dX1_dgama1+dyibar1_dY1*dY1_dgama1;
        dxdbar1_dgama1=dxdbar1_dxibar1*dxibar1_dgama1+dxdbar1_dyibar1*dyibar1_dgama1;
        dxibar1_dZ1=(T_hat(1,3)*(T_hat(3,1)*XYZ_1_hat(1)+T_hat(3,2)*XYZ_1_hat(2)+T_hat(3,3)*XYZ_1_hat(3)+T_hat(3,4))-...
                     T_hat(3,3)*(T_hat(1,1)*XYZ_1_hat(1)+T_hat(1,2)*XYZ_1_hat(2)+T_hat(1,3)*XYZ_1_hat(3)+T_hat(1,4)))/...
                    (T_hat(3,1)*XYZ_1_hat(1)+T_hat(3,2)*XYZ_1_hat(2)+T_hat(3,3)*XYZ_1_hat(3)+T_hat(3,4))^2;     
        dyibar1_dZ1=(T_hat(2,3)*(T_hat(3,1)*XYZ_1_hat(1)+T_hat(3,2)*XYZ_1_hat(2)+T_hat(3,3)*XYZ_1_hat(3)+T_hat(3,4))-...
                     T_hat(3,3)*(T_hat(2,1)*XYZ_1_hat(1)+T_hat(2,2)*XYZ_1_hat(2)+T_hat(2,3)*XYZ_1_hat(3)+T_hat(2,4)))/...
                    (T_hat(3,1)*XYZ_1_hat(1)+T_hat(3,2)*XYZ_1_hat(2)+T_hat(3,3)*XYZ_1_hat(3)+T_hat(3,4))^2; 
        dxdbar1_dZ1=dxdbar1_dxibar1*dxibar1_dZ1+dxdbar1_dyibar1*dyibar1_dZ1;
        dxibar1_dZ2=0;
        dyibar1_dZ2=0;
        dxdbar1_dZ2=dxdbar1_dxibar1*dxibar1_dZ2+dxdbar1_dyibar1*dyibar1_dZ2;
        dxibar1_dZ3=0;
        dyibar1_dZ3=0;
        dxdbar1_dZ3=dxdbar1_dxibar1*dxibar1_dZ3+dxdbar1_dyibar1*dyibar1_dZ3;        
        du1_dM=fx_hat*[dxdbar1_dlA dxdbar1_dlB dxdbar1_dlC dxdbar1_dalpha1 ...
                       dxdbar1_dbeita1 dxdbar1_dgama1 dxdbar1_dZ1 dxdbar1_dZ2 dxdbar1_dZ3];  
        dydbar1_dlA=dydbar1_dxibar1*dxibar1_dlA+dydbar1_dyibar1*dyibar1_dlA;
        dydbar1_dlB=dydbar1_dxibar1*dxibar1_dlB+dydbar1_dyibar1*dyibar1_dlB;
        dydbar1_dlC=dydbar1_dxibar1*dxibar1_dlC+dydbar1_dyibar1*dyibar1_dlC;
        dydbar1_dalpha1=dydbar1_dxibar1*dxibar1_dalpha1+dydbar1_dyibar1*dyibar1_dalpha1;
        dydbar1_dbeita1=dydbar1_dxibar1*dxibar1_dbeita1+dydbar1_dyibar1*dyibar1_dbeita1;
        dydbar1_dgama1=dydbar1_dxibar1*dxibar1_dgama1+dydbar1_dyibar1*dyibar1_dgama1;
        dydbar1_dZ1=dydbar1_dxibar1*dxibar1_dZ1+dydbar1_dyibar1*dyibar1_dZ1;
        dydbar1_dZ2=dydbar1_dxibar1*dxibar1_dZ2+dydbar1_dyibar1*dyibar1_dZ2;
        dydbar1_dZ3=dydbar1_dxibar1*dxibar1_dZ3+dydbar1_dyibar1*dyibar1_dZ3;
        dv1_dM=fy_hat*[dydbar1_dlA dydbar1_dlB dydbar1_dlC dydbar1_dalpha1 ...
                       dydbar1_dbeita1 dydbar1_dgama1 dydbar1_dZ1 dydbar1_dZ2 dydbar1_dZ3];
        dxibar2_dX2=(T_hat(1,1)*(T_hat(3,1)*XYZ_2_hat(1)+T_hat(3,2)*XYZ_2_hat(2)+...
                    T_hat(3,3)*XYZ_2_hat(3)+T_hat(3,4))-T_hat(3,1)*(T_hat(1,1)*XYZ_2_hat(1)+...
                    T_hat(1,2)*XYZ_2_hat(2)+T_hat(1,3)*XYZ_2_hat(3)+T_hat(1,4)))...
                    /(T_hat(3,1)*XYZ_2_hat(1)+T_hat(3,2)*XYZ_2_hat(2)+T_hat(3,3)*XYZ_2_hat(3)+T_hat(3,4))^2;
        dX2_dlA=0;
        dxibar2_dY2=(T_hat(1,2)*(T_hat(3,1)*XYZ_2_hat(1)+T_hat(3,2)*XYZ_2_hat(2)+...
                    T_hat(3,3)*XYZ_2_hat(3)+T_hat(3,4))-T_hat(3,2)*(T_hat(1,1)*XYZ_2_hat(1)+...
                    T_hat(1,2)*XYZ_2_hat(2)+T_hat(1,3)*XYZ_2_hat(3)+T_hat(1,4)))...
                    /(T_hat(3,1)*XYZ_2_hat(1)+T_hat(3,2)*XYZ_2_hat(2)+T_hat(3,3)*XYZ_2_hat(3)+T_hat(3,4))^2;
        dY2_dlA=0;
        dxibar2_dlA=dxibar2_dX2*dX2_dlA+dxibar2_dY2*dY2_dlA;
        dyibar2_dX2=(T_hat(2,1)*(T_hat(3,1)*XYZ_2_hat(1)+T_hat(3,2)*XYZ_2_hat(2)+...
                    T_hat(3,3)*XYZ_2_hat(3)+T_hat(3,4))-T_hat(3,1)*(T_hat(2,1)*XYZ_2_hat(1)+...
                    T_hat(2,2)*XYZ_2_hat(2)+T_hat(2,3)*XYZ_2_hat(3)+T_hat(2,4)))...
                    /(T_hat(3,1)*XYZ_2_hat(1)+T_hat(3,2)*XYZ_2_hat(2)+T_hat(3,3)*XYZ_2_hat(3)+T_hat(3,4))^2;        
        dyibar2_dY2=(T_hat(2,2)*(T_hat(3,1)*XYZ_2_hat(1)+T_hat(3,2)*XYZ_2_hat(2)+...
                    T_hat(3,3)*XYZ_2_hat(3)+T_hat(3,4))-T_hat(3,2)*(T_hat(2,1)*XYZ_2_hat(1)+...
                    T_hat(2,2)*XYZ_2_hat(2)+T_hat(2,3)*XYZ_2_hat(3)+T_hat(2,4)))...
                    /(T_hat(3,1)*XYZ_2_hat(1)+T_hat(3,2)*XYZ_2_hat(2)+T_hat(3,3)*XYZ_2_hat(3)+T_hat(3,4))^2;        
        dyibar2_dlA=dyibar2_dX2*dX2_dlA+dyibar2_dY2*dY2_dlA;
        dxdbar2_dlA=dxdbar2_dxibar2*dxibar2_dlA+dxdbar2_dyibar2*dyibar2_dlA;
        dX2_dlB=cos(alpha(bestInliersPosition(i))+beita(bestInliersPosition(i))+beita1_hat);
        dY2_dlB=sin(alpha(bestInliersPosition(i))+beita(bestInliersPosition(i))+beita1_hat);
        dxibar2_dlB=dxibar2_dX2*dX2_dlB+dxibar2_dY2*dY2_dlB;
        dyibar2_dlB=dyibar2_dX2*dX2_dlB+dyibar2_dY2*dY2_dlB;
        dxdbar2_dlB=dxdbar2_dxibar2*dxibar2_dlB+dxdbar2_dyibar2*dyibar2_dlB;
        dX2_dlC=0;
        dY2_dlC=0;
        dxibar2_dlC=dxibar2_dX2*dX2_dlC+dxibar2_dY2*dY2_dlC;
        dyibar2_dlC=dyibar2_dX2*dX2_dlC+dyibar2_dY2*dY2_dlC;
        dxdbar2_dlC=dxdbar2_dxibar2*dxibar2_dlC+dxdbar2_dyibar2*dyibar2_dlC;
        dX2_dalpha1=0;
        dY2_dalpha1=0;
        dxibar2_dalpha1=dxibar2_dX2*dX2_dalpha1+dxibar2_dY2*dY2_dalpha1;
        dyibar2_dalpha1=dyibar2_dX2*dX2_dalpha1+dyibar2_dY2*dY2_dalpha1;
        dxdbar2_dalpha1=dxdbar2_dxibar2*dxibar2_dalpha1+dxdbar2_dyibar2*dyibar2_dalpha1;
        dX2_dbeita1=-lB_hat*sin(alpha(bestInliersPosition(i))+beita(bestInliersPosition(i))+beita1_hat);
        dY2_dbeita1=lB_hat*cos(alpha(bestInliersPosition(i))+beita(bestInliersPosition(i))+beita1_hat);
        dxibar2_dbeita1=dxibar2_dX2*dX2_dbeita1+dxibar2_dY2*dY2_dbeita1;
        dyibar2_dbeita1=dyibar2_dX2*dX2_dbeita1+dyibar2_dY2*dY2_dbeita1;
        dxdbar2_dbeita1=dxdbar2_dxibar2*dxibar2_dbeita1+dxdbar2_dyibar2*dyibar2_dbeita1;
        dX2_dgama1=0;
        dY2_dgama1=0;
        dxibar2_dgama1=dxibar2_dX2*dX2_dgama1+dxibar2_dY2*dY2_dgama1;
        dyibar2_dgama1=dyibar2_dX2*dX2_dgama1+dyibar2_dY2*dY2_dgama1;
        dxdbar2_dgama1=dxdbar2_dxibar2*dxibar2_dgama1+dxdbar2_dyibar2*dyibar2_dgama1;
        dxibar2_dZ1=0;    
        dyibar2_dZ1=0;
        dxdbar2_dZ1=dxdbar2_dxibar2*dxibar2_dZ1+dxdbar2_dyibar2*dyibar2_dZ1;
        dxibar2_dZ2=(T_hat(1,3)*(T_hat(3,1)*XYZ_2_hat(1)+T_hat(3,2)*XYZ_2_hat(2)+T_hat(3,3)*XYZ_2_hat(3)+T_hat(3,4))-...
                     T_hat(3,3)*(T_hat(1,1)*XYZ_2_hat(1)+T_hat(1,2)*XYZ_2_hat(2)+T_hat(1,3)*XYZ_2_hat(3)+T_hat(1,4)))/...
                    (T_hat(3,1)*XYZ_2_hat(1)+T_hat(3,2)*XYZ_2_hat(2)+T_hat(3,3)*XYZ_2_hat(3)+T_hat(3,4))^2;     
        dyibar2_dZ2=(T_hat(2,3)*(T_hat(3,1)*XYZ_2_hat(1)+T_hat(3,2)*XYZ_2_hat(2)+T_hat(3,3)*XYZ_2_hat(3)+T_hat(3,4))-...
                     T_hat(3,3)*(T_hat(2,1)*XYZ_2_hat(1)+T_hat(2,2)*XYZ_2_hat(2)+T_hat(2,3)*XYZ_2_hat(3)+T_hat(2,4)))/...
                    (T_hat(3,1)*XYZ_2_hat(1)+T_hat(3,2)*XYZ_2_hat(2)+T_hat(3,3)*XYZ_2_hat(3)+T_hat(3,4))^2; 
        dxdbar2_dZ2=dxdbar2_dxibar2*dxibar2_dZ2+dxdbar2_dyibar2*dyibar2_dZ2;
        dxibar2_dZ3=0;
        dyibar2_dZ3=0;
        dxdbar2_dZ3=dxdbar2_dxibar2*dxibar2_dZ3+dxdbar2_dyibar2*dyibar2_dZ3;        
        du2_dM=fx_hat*[dxdbar2_dlA dxdbar2_dlB dxdbar2_dlC dxdbar2_dalpha1 ...
                       dxdbar2_dbeita1 dxdbar2_dgama1 dxdbar2_dZ1 dxdbar2_dZ2 dxdbar2_dZ3];
        dydbar2_dlA=dydbar2_dxibar2*dxibar2_dlA+dydbar2_dyibar2*dyibar2_dlA;
        dydbar2_dlB=dydbar2_dxibar2*dxibar2_dlB+dydbar2_dyibar2*dyibar2_dlB;
        dydbar2_dlC=dydbar2_dxibar2*dxibar2_dlC+dydbar2_dyibar2*dyibar2_dlC;
        dydbar2_dalpha1=dydbar2_dxibar2*dxibar2_dalpha1+dydbar2_dyibar2*dyibar2_dalpha1;
        dydbar2_dbeita1=dydbar2_dxibar2*dxibar2_dbeita1+dydbar2_dyibar2*dyibar2_dbeita1;
        dydbar2_dgama1=dydbar2_dxibar2*dxibar2_dgama1+dydbar2_dyibar2*dyibar2_dgama1;
        dydbar2_dZ1=dydbar2_dxibar2*dxibar2_dZ1+dydbar2_dyibar2*dyibar2_dZ1;
        dydbar2_dZ2=dydbar2_dxibar2*dxibar2_dZ2+dydbar2_dyibar2*dyibar2_dZ2;
        dydbar2_dZ3=dydbar2_dxibar2*dxibar2_dZ3+dydbar2_dyibar2*dyibar2_dZ3;
        dv2_dM=fy_hat*[dydbar2_dlA dydbar2_dlB dydbar2_dlC dydbar2_dalpha1 ...
                       dydbar2_dbeita1 dydbar2_dgama1 dydbar2_dZ1 dydbar2_dZ2 dydbar2_dZ3];
        dxibar3_dX3=(T_hat(1,1)*(T_hat(3,1)*XYZ_3_hat(1)+T_hat(3,2)*XYZ_3_hat(2)+...
                    T_hat(3,3)*XYZ_3_hat(3)+T_hat(3,4))-T_hat(3,1)*(T_hat(1,1)*XYZ_3_hat(1)+...
                    T_hat(1,2)*XYZ_3_hat(2)+T_hat(1,3)*XYZ_3_hat(3)+T_hat(1,4)))...
                    /(T_hat(3,1)*XYZ_3_hat(1)+T_hat(3,2)*XYZ_3_hat(2)+T_hat(3,3)*XYZ_3_hat(3)+T_hat(3,4))^2;
        dX3_dlA=0;
        dxibar3_dY3=(T_hat(1,2)*(T_hat(3,1)*XYZ_3_hat(1)+T_hat(3,2)*XYZ_3_hat(2)+...
                    T_hat(3,3)*XYZ_3_hat(3)+T_hat(3,4))-T_hat(3,2)*(T_hat(1,1)*XYZ_3_hat(1)+...
                    T_hat(1,2)*XYZ_3_hat(2)+T_hat(1,3)*XYZ_3_hat(3)+T_hat(1,4)))...
                    /(T_hat(3,1)*XYZ_3_hat(1)+T_hat(3,2)*XYZ_3_hat(2)+T_hat(3,3)*XYZ_3_hat(3)+T_hat(3,4))^2;
        dY3_dlA=0;
        dxibar3_dlA=dxibar3_dX3*dX3_dlA+dxibar3_dY3*dY3_dlA;
        dyibar3_dX3=(T_hat(2,1)*(T_hat(3,1)*XYZ_3_hat(1)+T_hat(3,2)*XYZ_3_hat(2)+...
                    T_hat(3,3)*XYZ_3_hat(3)+T_hat(3,4))-T_hat(3,1)*(T_hat(2,1)*XYZ_3_hat(1)+...
                    T_hat(2,2)*XYZ_3_hat(2)+T_hat(2,3)*XYZ_3_hat(3)+T_hat(2,4)))...
                    /(T_hat(3,1)*XYZ_3_hat(1)+T_hat(3,2)*XYZ_3_hat(2)+T_hat(3,3)*XYZ_3_hat(3)+T_hat(3,4))^2;        
        dyibar3_dY3=(T_hat(2,2)*(T_hat(3,1)*XYZ_3_hat(1)+T_hat(3,2)*XYZ_3_hat(2)+...
                    T_hat(3,3)*XYZ_3_hat(3)+T_hat(3,4))-T_hat(3,2)*(T_hat(2,1)*XYZ_3_hat(1)+...
                    T_hat(2,2)*XYZ_3_hat(2)+T_hat(2,3)*XYZ_3_hat(3)+T_hat(2,4)))...
                    /(T_hat(3,1)*XYZ_3_hat(1)+T_hat(3,2)*XYZ_3_hat(2)+T_hat(3,3)*XYZ_3_hat(3)+T_hat(3,4))^2;        
        dyibar3_dlA=dyibar3_dX3*dX3_dlA+dyibar3_dY3*dY3_dlA;
        dxdbar3_dlA=dxdbar3_dxibar3*dxibar3_dlA+dxdbar3_dyibar3*dyibar3_dlA;
        dX3_dlB=0;
        dY3_dlB=0;
        dxibar3_dlB=dxibar3_dX3*dX3_dlB+dxibar3_dY3*dY3_dlB;
        dyibar3_dlB=dyibar3_dX3*dX3_dlB+dyibar3_dY3*dY3_dlB;
        dxdbar3_dlB=dxdbar3_dxibar3*dxibar3_dlB+dxdbar3_dyibar3*dyibar3_dlB;
        dX3_dlC=cos(alpha(bestInliersPosition(i))+beita(bestInliersPosition(i))+gama(bestInliersPosition(i))+gama1_hat);
        dY3_dlC=sin(alpha(bestInliersPosition(i))+beita(bestInliersPosition(i))+gama(bestInliersPosition(i))+gama1_hat);
        dxibar3_dlC=dxibar3_dX3*dX3_dlC+dxibar3_dY3*dY3_dlC;
        dyibar3_dlC=dyibar3_dX3*dX3_dlC+dyibar3_dY3*dY3_dlC;
        dxdbar3_dlC=dxdbar3_dxibar3*dxibar3_dlC+dxdbar3_dyibar3*dyibar3_dlC;
        dX3_dalpha1=0;
        dY3_dalpha1=0;
        dxibar3_dalpha1=dxibar3_dX3*dX3_dalpha1+dxibar3_dY3*dY3_dalpha1;
        dyibar3_dalpha1=dyibar3_dX3*dX3_dalpha1+dyibar3_dY3*dY3_dalpha1;
        dxdbar3_dalpha1=dxdbar3_dxibar3*dxibar3_dalpha1+dxdbar3_dyibar3*dyibar3_dalpha1;
        dX3_dbeita1=0;
        dY3_dbeita1=0;
        dxibar3_dbeita1=dxibar3_dX3*dX3_dbeita1+dxibar3_dY3*dY3_dbeita1;
        dyibar3_dbeita1=dyibar3_dX3*dX3_dbeita1+dyibar3_dY3*dY3_dbeita1;
        dxdbar3_dbeita1=dxdbar3_dxibar3*dxibar3_dbeita1+dxdbar3_dyibar3*dyibar3_dbeita1;
        dX3_dgama1=-lC_hat*sin(alpha(bestInliersPosition(i))+beita(bestInliersPosition(i))+gama(bestInliersPosition(i))+gama1_hat);
        dY3_dgama1=lC_hat*cos(alpha(bestInliersPosition(i))+beita(bestInliersPosition(i))+gama(bestInliersPosition(i))+gama1_hat);
        dxibar3_dgama1=dxibar3_dX3*dX3_dgama1+dxibar3_dY3*dY3_dgama1;
        dyibar3_dgama1=dyibar3_dX3*dX3_dgama1+dyibar3_dY3*dY3_dgama1;
        dxdbar3_dgama1=dxdbar3_dxibar3*dxibar3_dgama1+dxdbar3_dyibar3*dyibar3_dgama1;
        dxibar3_dZ1=0;    
        dyibar3_dZ1=0;
        dxdbar3_dZ1=dxdbar3_dxibar3*dxibar3_dZ1+dxdbar3_dyibar3*dyibar3_dZ1;
        dxibar3_dZ2=0;
        dyibar3_dZ2=0;
        dxdbar3_dZ2=dxdbar3_dxibar3*dxibar3_dZ2+dxdbar3_dyibar3*dyibar3_dZ2;
        dxibar3_dZ3=(T_hat(1,3)*(T_hat(3,1)*XYZ_3_hat(1)+T_hat(3,2)*XYZ_3_hat(2)+T_hat(3,3)*XYZ_3_hat(3)+T_hat(3,4))-...
                     T_hat(3,3)*(T_hat(1,1)*XYZ_3_hat(1)+T_hat(1,2)*XYZ_3_hat(2)+T_hat(1,3)*XYZ_3_hat(3)+T_hat(1,4)))/...
                    (T_hat(3,1)*XYZ_3_hat(1)+T_hat(3,2)*XYZ_3_hat(2)+T_hat(3,3)*XYZ_3_hat(3)+T_hat(3,4))^2;           
        dyibar3_dZ3=(T_hat(2,3)*(T_hat(3,1)*XYZ_3_hat(1)+T_hat(3,2)*XYZ_3_hat(2)+T_hat(3,3)*XYZ_3_hat(3)+T_hat(3,4))-...
                     T_hat(3,3)*(T_hat(2,1)*XYZ_3_hat(1)+T_hat(2,2)*XYZ_3_hat(2)+T_hat(2,3)*XYZ_3_hat(3)+T_hat(2,4)))/...
                    (T_hat(3,1)*XYZ_3_hat(1)+T_hat(3,2)*XYZ_3_hat(2)+T_hat(3,3)*XYZ_3_hat(3)+T_hat(3,4))^2;
        dxdbar3_dZ3=dxdbar3_dxibar3*dxibar3_dZ3+dxdbar3_dyibar3*dyibar3_dZ3;
        du3_dM=fx_hat*[dxdbar3_dlA dxdbar3_dlB dxdbar3_dlC dxdbar3_dalpha1 ...
                       dxdbar3_dbeita1 dxdbar3_dgama1 dxdbar3_dZ1 dxdbar3_dZ2 dxdbar3_dZ3];   
        dydbar3_dlA=dydbar3_dxibar3*dxibar3_dlA+dydbar3_dyibar3*dyibar3_dlA;
        dydbar3_dlB=dydbar3_dxibar3*dxibar3_dlB+dydbar3_dyibar3*dyibar3_dlB;
        dydbar3_dlC=dydbar3_dxibar3*dxibar3_dlC+dydbar3_dyibar3*dyibar3_dlC;
        dydbar3_dalpha1=dydbar3_dxibar3*dxibar3_dalpha1+dydbar3_dyibar3*dyibar3_dalpha1;
        dydbar3_dbeita1=dydbar3_dxibar3*dxibar3_dbeita1+dydbar3_dyibar3*dyibar3_dbeita1;
        dydbar3_dgama1=dydbar3_dxibar3*dxibar3_dgama1+dydbar3_dyibar3*dyibar3_dgama1;
        dydbar3_dZ1=dydbar3_dxibar3*dxibar3_dZ1+dydbar3_dyibar3*dyibar3_dZ1;
        dydbar3_dZ2=dydbar3_dxibar3*dxibar3_dZ2+dydbar3_dyibar3*dyibar3_dZ2;
        dydbar3_dZ3=dydbar3_dxibar3*dxibar3_dZ3+dydbar3_dyibar3*dyibar3_dZ3;
        dv3_dM=fy_hat*[dydbar3_dlA dydbar3_dlB dydbar3_dlC dydbar3_dalpha1 ...
                       dydbar3_dbeita1 dydbar3_dgama1 dydbar3_dZ1 dydbar3_dZ2 dydbar3_dZ3];
        JM(6*(i-1)+1:6*(i-1)+6,:)=[du1_dM;dv1_dM;du2_dM;dv2_dM;du3_dM;dv3_dM];    
   
    end
    
    J=[JN JT JD JM];
    
    step=-inv(J'*J+u*eye(24,24))*J'*E;
    ParaLThisTimeNew=ParaL_hat+step;
    ParaLAll(:,t)=ParaLThisTimeNew;
    
    Esum2(t-1,1)=sqrt(sum(E.^2)/length(E));
    
    disp(['IterationsTime=' num2str(t) '   AverageResidual=' num2str(Esum2(t-1,1)) ]);
    
    if t>10
        if (abs(Esum2(t-1,1)-Esum2(t-2,1))<ErrorTolerance && abs(Esum2(t-2,1)-Esum2(t-3,1))<ErrorTolerance && abs(Esum2(t-3,1)-Esum2(t-4,1))<ErrorTolerance)
            disp(['Reached ErrorTolerance']);
            break;
        end
    end   
end

ParaLBest=ParaLThisTimeNew;
end

